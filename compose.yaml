services:

  postgres:
    image: postgres:16-alpine
    container_name: rmm-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB:       ${POSTGRES_DB}
      POSTGRES_USER:     ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks: [rmm-internal]
    healthcheck:
      test: ["CMD-SHELL","pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  redis:
    image: redis:7-alpine
    container_name: rmm-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes: [redis_data:/data]
    networks: [rmm-internal]
    healthcheck:
      test: ["CMD","redis-cli","--no-auth-warning","-a","${REDIS_PASSWORD}","ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  backend:
    build:
      context: https://github.com/tesladog/sovereign-rmm.git#main
      dockerfile: backend/Dockerfile
    pull_policy: build
    container_name: rmm-backend
    restart: unless-stopped
    environment:
      DATABASE_URL:   postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      REDIS_URL:      redis://:${REDIS_PASSWORD}@redis:6379/0
      AGENT_TOKEN:    ${AGENT_TOKEN}
      SERVER_IP:      ${SERVER_IP}
      BACKEND_PORT:   ${BACKEND_PORT}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    volumes:
      - agent_builds:/app/agent-builds
    ports:
      - "${BACKEND_PORT}:8000"
    networks: [rmm-internal, rmm-external]
    depends_on:
      postgres: {condition: service_healthy}
      redis:    {condition: service_healthy}
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  frontend:
    build:
      context: https://github.com/tesladog/sovereign-rmm.git#main
      dockerfile: frontend/Dockerfile
    pull_policy: build
    container_name: rmm-frontend
    restart: unless-stopped
    ports:
      - "${DASHBOARD_PORT}:80"
    networks: [rmm-internal, rmm-external]
    depends_on:
      backend: {condition: service_healthy}

  guacamole-schema-extract:
    image: guacamole/guacamole:latest
    container_name: rmm-guacamole-schema-extract
    restart: "no"
    entrypoint:
      - sh
      - -c
      - |
        set +e
        # Try known initdb.sh locations across guacamole versions
        for p in /opt/guacamole/bin/initdb.sh /usr/local/tomcat/webapps/guacamole/WEB-INF/lib/initdb.sh; do
          if [ -f "$$p" ]; then
            "$$p" --postgresql > /init/initdb.sql && echo "Schema extracted from $$p" && exit 0
          fi
        done
        # Fallback: extract SQL from JDBC jar if present
        JAR=$$(find / -name "guacamole-auth-jdbc-postgresql*.jar" 2>/dev/null | head -1)
        if [ -n "$$JAR" ]; then
          unzip -p "$$JAR" "*.sql" > /init/initdb.sql 2>/dev/null && echo "Schema from jar" && exit 0
        fi
        # Last resort: download schema from GitHub
        wget -qO /init/initdb.sql "https://raw.githubusercontent.com/apache/guacamole-client/main/extensions/guacamole-auth-jdbc/modules/guacamole-auth-jdbc-postgresql/schema/001-create-schema.sql" && echo "Schema downloaded" && exit 0
        echo "Could not extract schema" && exit 0
    volumes: [guacamole_init:/init]
    networks: [rmm-internal]

  guacamole-init:
    image: postgres:16-alpine
    container_name: rmm-guacamole-init
    restart: "no"
    entrypoint:
      - sh
      - -c
      - |
        until pg_isready -h postgres -U ${POSTGRES_USER}; do sleep 2; done
        TABLE=$$(psql postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres/${POSTGRES_DB} -tAc "SELECT COUNT(*) FROM information_schema.tables WHERE table_name='guacamole_connection'" 2>/dev/null || echo 0)
        if [ "$$TABLE" -gt "0" ]; then
          echo "Guacamole schema already exists, skipping."
        elif [ -f /init/initdb.sql ] && [ -s /init/initdb.sql ]; then
          psql postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres/${POSTGRES_DB} -f /init/initdb.sql && echo "Schema imported."
        else
          echo "No schema SQL found â€” Guacamole DB init skipped. Remote desktop may not work until schema is loaded."
        fi
    volumes: [guacamole_init:/init]
    networks: [rmm-internal]
    depends_on:
      postgres: {condition: service_healthy}
      guacamole-schema-extract: {condition: service_completed_successfully}

  guacd:
    image: guacamole/guacd:latest
    container_name: rmm-guacd
    restart: unless-stopped
    networks: [rmm-internal]

  guacamole:
    image: guacamole/guacamole:latest
    container_name: rmm-guacamole
    restart: unless-stopped
    environment:
      GUACD_HOSTNAME:      guacd
      POSTGRESQL_HOSTNAME: postgres
      POSTGRESQL_PORT:     5432
      POSTGRESQL_DATABASE: ${POSTGRES_DB}
      POSTGRESQL_USER:     ${POSTGRES_USER}
      POSTGRESQL_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "${GUACAMOLE_PORT}:8080"
    networks: [rmm-internal, rmm-external]
    depends_on:
      guacd: {condition: service_started}
      guacamole-init: {condition: service_completed_successfully}

  netbird-mgmt:
    image: netbirdio/management:latest
    container_name: rmm-netbird-mgmt
    restart: unless-stopped
    environment:
      - NETBIRD_MGMT_DNS_DOMAIN=netbird.local
    volumes:
      - netbird_mgmt_data:/var/lib/netbird
    ports: ["${NETBIRD_MGMT_PORT}:80"]
    networks: [rmm-internal, rmm-external]

  netbird-signal:
    image: netbirdio/signal:latest
    container_name: rmm-netbird-signal
    restart: unless-stopped
    volumes: [netbird_signal_data:/var/lib/netbird]
    ports: ["${NETBIRD_SIGNAL_PORT}:80"]
    networks: [rmm-internal, rmm-external]

  netbird-relay:
    image: netbirdio/relay:latest
    container_name: rmm-netbird-relay
    restart: unless-stopped
    environment:
      NB_LOG_LEVEL:       info
      NB_LISTEN_ADDRESS:  ":33080"
      NB_EXPOSED_ADDRESS: "${SERVER_IP}:${NETBIRD_RELAY_PORT}"
      NB_AUTH_SECRET:     ${NETBIRD_RELAY_SECRET}
    ports: ["${NETBIRD_RELAY_PORT}:33080"]
    networks: [rmm-internal, rmm-external]

networks:
  rmm-internal: {driver: bridge, internal: true}
  rmm-external: {driver: bridge}

volumes:
  postgres_data:
  redis_data:
  agent_builds:
  guacamole_init:
  netbird_mgmt_data:
  netbird_signal_data:
