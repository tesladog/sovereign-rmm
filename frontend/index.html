<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sovereign RMM</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg0: #050608;
  --bg1: #0a0c10;
  --bg2: #0f1218;
  --bg3: #161b24;
  --bg4: #1e2530;
  --border: #232a36;
  --border2: #2d3748;
  --text:  #e2e8f0;
  --text2: #94a3b8;
  --text3: #4a5568;
  --accent: #00e5ff;
  --accent2: #0097a7;
  --green: #00e676;
  --yellow: #ffd740;
  --red: #ff5252;
  --orange: #ff9100;
  --mono: 'IBM Plex Mono', monospace;
  --sans: 'IBM Plex Sans', sans-serif;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; }
body { background: var(--bg0); color: var(--text); font-family: var(--sans); font-size: 14px; display: flex; }

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  width: 220px; min-width: 220px;
  background: var(--bg1);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  height: 100vh; overflow: hidden;
}
.logo {
  padding: 20px 16px 16px;
  border-bottom: 1px solid var(--border);
  font-family: var(--mono);
}
.logo-title {
  font-size: 13px; font-weight: 600; letter-spacing: 0.15em;
  color: var(--accent); text-transform: uppercase;
}
.logo-sub { font-size: 10px; color: var(--text3); letter-spacing: 0.05em; margin-top: 2px; }
.nav { flex: 1; overflow-y: auto; padding: 8px 0; }
.nav-section {
  padding: 12px 16px 4px;
  font-size: 9px; font-weight: 600; letter-spacing: 0.15em;
  color: var(--text3); text-transform: uppercase; font-family: var(--mono);
}
.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 16px; cursor: pointer; font-size: 13px;
  color: var(--text2); transition: all 0.15s; border-left: 2px solid transparent;
  font-family: var(--sans);
}
.nav-item:hover { color: var(--text); background: var(--bg2); }
.nav-item.active { color: var(--accent); background: var(--bg2); border-left-color: var(--accent); }
.nav-icon { font-size: 14px; width: 18px; text-align: center; opacity: 0.8; }
.sidebar-footer {
  padding: 12px 16px; border-top: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px; font-size: 11px;
  font-family: var(--mono); color: var(--text3);
}
.ws-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--red); transition: background 0.3s;
  flex-shrink: 0;
}
.ws-dot.connected { background: var(--green); box-shadow: 0 0 6px var(--green); }
.ws-dot.reconnecting { background: var(--yellow); animation: pulse 1s infinite; }

/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
.page { display: none; flex-direction: column; height: 100%; overflow: hidden; }
.page.active { display: flex; }

.topbar {
  padding: 16px 24px; border-bottom: 1px solid var(--border);
  background: var(--bg1); display: flex; align-items: center;
  justify-content: space-between; flex-shrink: 0;
}
.topbar-title { font-size: 16px; font-weight: 600; }
.topbar-sub { font-size: 12px; color: var(--text3); margin-top: 2px; font-family: var(--mono); }
.topbar-actions { display: flex; gap: 8px; align-items: center; }

.page-body { flex: 1; overflow-y: auto; padding: 20px 24px; }

/* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 8px; padding: 16px;
}
.cards-row { display: grid; gap: 16px; margin-bottom: 20px; }
.card-label { font-size: 11px; font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text3); font-family: var(--mono); }
.card-value { font-size: 28px; font-weight: 600; margin-top: 6px; font-family: var(--mono); }
.card-value.accent { color: var(--accent); }
.card-value.green { color: var(--green); }
.card-value.red { color: var(--red); }

/* â”€â”€ TABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
table { width: 100%; border-collapse: collapse; }
thead th {
  background: var(--bg3); padding: 10px 14px; text-align: left;
  font-size: 10px; font-weight: 600; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--text3); font-family: var(--mono);
  border-bottom: 1px solid var(--border);
}
tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; cursor: pointer; }
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: var(--bg3); }
tbody td { padding: 10px 14px; font-size: 13px; }

/* â”€â”€ BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 8px; border-radius: 4px; font-size: 11px;
  font-weight: 500; font-family: var(--mono);
}
.badge-online  { background: rgba(0,230,118,0.12); color: var(--green); }
.badge-offline { background: rgba(255,82,82,0.12);  color: var(--red); }
.badge-warning { background: rgba(255,215,64,0.12); color: var(--yellow); }
.badge-info    { background: rgba(0,229,255,0.12);  color: var(--accent); }
.badge-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 7px 14px; border-radius: 6px; font-size: 13px;
  font-weight: 500; cursor: pointer; border: none; transition: all 0.15s;
  font-family: var(--sans);
}
.btn-primary { background: var(--accent); color: var(--bg0); }
.btn-primary:hover { background: #33eeff; }
.btn-primary:disabled { background: var(--bg4); color: var(--text3); cursor: not-allowed; }
.btn-ghost { background: var(--bg3); color: var(--text2); border: 1px solid var(--border2); }
.btn-ghost:hover { background: var(--bg4); color: var(--text); }
.btn-danger { background: rgba(255,82,82,0.15); color: var(--red); border: 1px solid rgba(255,82,82,0.3); }
.btn-danger:hover { background: rgba(255,82,82,0.25); }
.btn-sm { padding: 5px 10px; font-size: 12px; }
.btn-icon { padding: 6px; width: 30px; height: 30px; justify-content: center; }

/* â”€â”€ FORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-group { margin-bottom: 14px; }
.form-label { font-size: 11px; font-weight: 500; color: var(--text3); display: block; margin-bottom: 5px; font-family: var(--mono); text-transform: uppercase; letter-spacing: 0.05em; }
.form-input, .form-select, .form-textarea {
  width: 100%; background: var(--bg3); border: 1px solid var(--border2);
  border-radius: 6px; padding: 8px 10px; color: var(--text); font-size: 13px;
  font-family: var(--sans); outline: none; transition: border-color 0.15s;
}
.form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); }
.form-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234a5568' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 28px; }
.form-textarea { resize: vertical; font-family: var(--mono); font-size: 12px; }
.form-grid { display: grid; gap: 12px; }
.form-grid-2 { grid-template-columns: 1fr 1fr; }
.form-grid-3 { grid-template-columns: 1fr 1fr 1fr; }

/* â”€â”€ PROGRESS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.progress-bar { height: 4px; background: var(--bg4); border-radius: 2px; overflow: hidden; }
.progress-fill { height: 100%; background: var(--accent); transition: width 0.5s; border-radius: 2px; }
.progress-fill.done { background: var(--green); }
.progress-fill.failed { background: var(--red); }

/* â”€â”€ MINI GAUGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.gauge-row { display: flex; flex-direction: column; gap: 4px; }
.gauge-label { display: flex; justify-content: space-between; font-size: 11px; color: var(--text3); font-family: var(--mono); }
.gauge { height: 3px; background: var(--bg4); border-radius: 2px; }
.gauge-fill { height: 100%; border-radius: 2px; transition: width 0.5s; }

/* â”€â”€ SECTION HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.section-title { font-size: 13px; font-weight: 600; }
.section-actions { display: flex; gap: 8px; }

/* â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.search-bar {
  display: flex; align-items: center; gap: 8px;
  background: var(--bg3); border: 1px solid var(--border2);
  border-radius: 6px; padding: 7px 12px;
}
.search-bar input { background: none; border: none; color: var(--text); font-size: 13px; outline: none; width: 200px; }
.search-bar input::placeholder { color: var(--text3); }

/* â”€â”€ PANEL (slide-in detail) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  z-index: 100; display: none;
}
.panel-overlay.open { display: block; }
.panel {
  position: fixed; top: 0; right: -480px; width: 480px; height: 100vh;
  background: var(--bg1); border-left: 1px solid var(--border);
  z-index: 101; transition: right 0.25s; overflow-y: auto; padding: 20px;
}
.panel.open { right: 0; }
.panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
.panel-title { font-size: 16px; font-weight: 600; }
.panel-close { background: none; border: none; color: var(--text3); font-size: 20px; cursor: pointer; }
.panel-close:hover { color: var(--text); }

/* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  z-index: 200; display: none; align-items: center; justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--bg2); border: 1px solid var(--border2);
  border-radius: 10px; width: 560px; max-width: 95vw; max-height: 90vh;
  overflow-y: auto;
}
.modal-header { display: flex; align-items: center; justify-content: space-between; padding: 18px 20px; border-bottom: 1px solid var(--border); }
.modal-title { font-size: 15px; font-weight: 600; }
.modal-close { background: none; border: none; color: var(--text3); font-size: 20px; cursor: pointer; line-height: 1; }
.modal-close:hover { color: var(--text); }
.modal-body { padding: 20px; }
.modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 999; display: flex; flex-direction: column; gap: 8px; }
.toast {
  background: var(--bg3); border: 1px solid var(--border2);
  border-radius: 8px; padding: 12px 16px; font-size: 13px;
  display: flex; align-items: center; gap: 10px;
  animation: slideIn 0.2s; max-width: 320px;
}
.toast.success { border-left: 3px solid var(--green); }
.toast.error   { border-left: 3px solid var(--red); }
.toast.info    { border-left: 3px solid var(--accent); }

/* â”€â”€ TERMINAL OUTPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.terminal {
  background: var(--bg0); border: 1px solid var(--border);
  border-radius: 6px; padding: 12px; font-family: var(--mono);
  font-size: 12px; color: var(--green); line-height: 1.6;
  max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-break: break-all;
}

/* â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
.tab {
  padding: 8px 16px; font-size: 13px; cursor: pointer;
  color: var(--text3); border-bottom: 2px solid transparent;
  margin-bottom: -1px; transition: all 0.15s;
}
.tab:hover { color: var(--text2); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }

/* â”€â”€ SETTINGS SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.settings-section { margin-bottom: 24px; }
.settings-section-title {
  font-size: 11px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--text3); font-family: var(--mono);
  padding: 0 0 10px; border-bottom: 1px solid var(--border); margin-bottom: 14px;
}
.setting-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 0; border-bottom: 1px solid var(--border);
}
.setting-row:last-child { border-bottom: none; }
.setting-info { flex: 1; }
.setting-label { font-size: 13px; font-weight: 500; }
.setting-desc  { font-size: 11px; color: var(--text3); margin-top: 2px; font-family: var(--mono); }
.setting-control { flex-shrink: 0; margin-left: 16px; }
.setting-control .form-input { width: 220px; }
.toggle {
  width: 36px; height: 20px; background: var(--bg4); border-radius: 10px;
  cursor: pointer; position: relative; transition: background 0.2s;
  border: 1px solid var(--border2);
}
.toggle.on { background: var(--accent); }
.toggle::after {
  content: ''; position: absolute; top: 2px; left: 2px;
  width: 14px; height: 14px; border-radius: 50%; background: white;
  transition: left 0.2s;
}
.toggle.on::after { left: 18px; }

/* â”€â”€ TASK STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.task-status { display: flex; align-items: center; gap: 6px; font-family: var(--mono); font-size: 12px; }
.status-pending  { color: var(--text3); }
.status-running  { color: var(--yellow); }
.status-done     { color: var(--green); }
.status-failed   { color: var(--red); }
.status-cancelled{ color: var(--text3); text-decoration: line-through; }

/* â”€â”€ SCRIPT CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.script-card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 8px; padding: 14px; cursor: pointer;
  transition: border-color 0.15s;
}
.script-card:hover { border-color: var(--accent); }
.script-card-name { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
.script-card-desc { font-size: 12px; color: var(--text3); margin-bottom: 10px; line-height: 1.5; }
.script-card-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.chip {
  padding: 2px 8px; border-radius: 20px; font-size: 11px;
  font-family: var(--mono); background: var(--bg4); color: var(--text3);
  border: 1px solid var(--border);
}
.chip.win   { color: #40a9ff; border-color: rgba(64,169,255,0.3); }
.chip.linux { color: #ff9100; border-color: rgba(255,145,0,0.3); }
.chip.android { color: var(--green); border-color: rgba(0,230,118,0.3); }
.chip.all   { color: var(--accent); border-color: rgba(0,229,255,0.3); }

/* â”€â”€ ASSET CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.asset-tag-badge {
  font-family: var(--mono); font-size: 13px; font-weight: 600;
  padding: 4px 10px; background: var(--bg4); border: 1px solid var(--border2);
  border-radius: 6px; color: var(--accent);
}

/* â”€â”€ DISK BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.disk-item { display: flex; align-items: center; gap: 10px; padding: 6px 0; border-bottom: 1px solid var(--border); }
.disk-item:last-child { border-bottom: none; }
.disk-item-name { font-size: 12px; font-family: var(--mono); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.disk-item-size { font-size: 12px; font-family: var(--mono); color: var(--text2); width: 60px; text-align: right; flex-shrink: 0; }
.disk-item-bar { width: 80px; flex-shrink: 0; }

/* â”€â”€ ANIMATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
@keyframes slideIn { from{transform:translateX(20px);opacity:0} to{transform:translateX(0);opacity:1} }
@keyframes spin { to{transform:rotate(360deg)} }
.spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }

/* â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loginScreen {
  position: fixed; inset: 0; background: var(--bg0);
  display: flex; align-items: center; justify-content: center; z-index: 9999;
}
.login-box { width: 360px; }
.login-title { font-size: 22px; font-weight: 600; text-align: center; margin-bottom: 4px; font-family: var(--mono); color: var(--accent); letter-spacing: 0.1em; }
.login-sub   { font-size: 12px; color: var(--text3); text-align: center; margin-bottom: 28px; font-family: var(--mono); }
.login-error { color: var(--red); font-size: 12px; text-align: center; margin-top: 10px; font-family: var(--mono); }
</style>
</head>
<body>

<!-- LOCKDOWN BANNER -->
<div id="lockdownBanner" style="display:none;position:fixed;top:0;left:0;right:0;z-index:9998;background:#ff5252;color:#fff;text-align:center;padding:10px;font-weight:600;font-family:var(--mono);letter-spacing:.1em;font-size:13px">ğŸ”’ LOCKDOWN MODE ACTIVE â€” All logins blocked <button onclick="showPage('lockdown')" style="margin-left:16px;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.4);color:#fff;padding:3px 10px;border-radius:4px;cursor:pointer;font-size:12px">Manage</button></div>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-title">SOVEREIGN</div>
    <div class="login-sub">Remote Management &amp; Monitoring</div>
    <div class="form-group">
      <label class="form-label">Username</label>
      <input class="form-input" id="loginUser" type="text" value="admin" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input class="form-input" id="loginPass" type="password" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="doLogin()">Sign In</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="logo">
    <div class="logo-title">Sovereign</div>
    <div class="logo-sub">RMM v2.0</div>
  </div>
  <nav class="nav">
    <div class="nav-section">Overview</div>
    <div class="nav-item active" onclick="showPage('dashboard')">
      <span class="nav-icon">â—ˆ</span> Dashboard
    </div>
    <div class="nav-item" onclick="showPage('devices')">
      <span class="nav-icon">â–£</span> Devices
    </div>

    <div class="nav-section">Automation</div>
    <div class="nav-item" onclick="showPage('tasks')">
      <span class="nav-icon">âŠ</span> Tasks
    </div>
    <div class="nav-item" onclick="showPage('scripts')">
      <span class="nav-icon">âŒ˜</span> Script Library
    </div>

    <div class="nav-section">Management</div>
    <div class="nav-item" onclick="showPage('inventory')">
      <span class="nav-icon">â—‰</span> Inventory
    </div>
    <div class="nav-item" onclick="showPage('deploy')">
      <span class="nav-icon">â¬‡</span> Deploy
    </div>

    <div class="nav-section">Tools</div>
    <div class="nav-item" onclick="showPage('wol')">
      <span class="nav-icon">âš¡</span> Wake on LAN
    </div>
    <div class="nav-item" onclick="showPage('asset-tags')">
      <span class="nav-icon">ğŸ·</span> Asset Tags
    </div>

    <div class="nav-section">Config</div>
    <div class="nav-item" onclick="showPage('lockdown')">
      <span class="nav-icon">ğŸ”’</span> Lockdown
    </div>
    <div class="nav-item" onclick="showPage('policies')">
      <span class="nav-icon">â—±</span> Policies
    </div>
    <div class="nav-item" onclick="showPage('email')">
      <span class="nav-icon">âœ‰</span> Email Alerts
    </div>
    <div class="nav-item" onclick="showPage('netbird')">
      <span class="nav-icon">â¬¡</span> Netbird VPN
    </div>
    <div class="nav-item" onclick="showPage('settings')">
      <span class="nav-icon">âš™</span> Settings
    </div>
    <div class="nav-item" onclick="showPage('backup')">
      <span class="nav-icon">ğŸ“¦</span> Backup
    </div>
    <div class="nav-item" onclick="showPage('groups')">
      <span class="nav-icon">ğŸ—‚</span> Groups
    </div>
    <div class="nav-item" onclick="showPage('software')">
      <span class="nav-icon">ğŸ“‹</span> Software
    </div>
    <div class="nav-item" onclick="showPage('alert-rules')">
      <span class="nav-icon">ğŸ””</span> Alert Rules
    </div>
    <div class="nav-item" onclick="showPage('reports')">
      <span class="nav-icon">ğŸ“Š</span> Reports
    </div>
    <div class="nav-item" onclick="showPage('logs')">
      <span class="nav-icon">â‰¡</span> Logs
    </div>
  </nav>
  <div class="sidebar-footer">
    <div class="ws-dot" id="wsDot"></div>
    <span id="wsStatus">Connecting...</span>
  </div>
</aside>

<!-- MAIN -->
<div class="main">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="page-dashboard">
  <div class="topbar">
    <div>
      <div class="topbar-title">Dashboard</div>
      <div class="topbar-sub" id="dashLastUpdate">Loading...</div>
    </div>
    <div class="topbar-actions">
      <button class="btn btn-ghost btn-sm" onclick="refreshDashboard()">â†» Refresh</button>
      <button class="btn btn-primary btn-sm" onclick="openModal('modalTask')">ï¼‹ New Task</button>
    </div>
  </div>
  <div class="page-body">
    <div class="cards-row" style="grid-template-columns:repeat(4,1fr)">
      <div class="card">
        <div class="card-label">Total Devices</div>
        <div class="card-value accent" id="statTotal">â€”</div>
      </div>
      <div class="card">
        <div class="card-label">Online Now</div>
        <div class="card-value green" id="statOnline">â€”</div>
      </div>
      <div class="card">
        <div class="card-label">Offline</div>
        <div class="card-value red" id="statOffline">â€”</div>
      </div>
      <div class="card">
        <div class="card-label">Tasks Pending</div>
        <div class="card-value" id="statTasks">â€”</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px">
      <div>
        <div class="section-header">
          <div class="section-title">Online Devices</div>
          <button class="btn btn-ghost btn-sm" onclick="showPage('devices')">View All â†’</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Device</th><th>Platform</th><th>CPU</th><th>RAM</th><th>Battery</th><th>Last Seen</th></tr></thead>
            <tbody id="dashDeviceTable"><tr><td colspan="6" style="text-align:center;padding:30px;color:var(--text3)">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="section-header"><div class="section-title">Recent Activity</div></div>
        <div id="recentLogs" style="display:flex;flex-direction:column;gap:6px">
          <div style="color:var(--text3);font-size:12px;padding:20px;text-align:center">Loading...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• DEVICES â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-devices">
  <div class="topbar">
    <div>
      <div class="topbar-title">Devices</div>
      <div class="topbar-sub" id="deviceCount">All managed devices</div>
    </div>
    <div class="topbar-actions">
      <div class="search-bar">
        <span style="color:var(--text3)">âŒ•</span>
        <input type="text" placeholder="Search devices..." id="deviceSearch" oninput="filterDevices()">
      </div>
      <select class="form-select" style="width:130px" id="platformFilter" onchange="filterDevices()">
        <option value="">All Platforms</option>
        <option value="windows">Windows</option>
        <option value="linux">Linux</option>
        <option value="android">Android</option>
      </select>
    </div>
  </div>
  <div class="page-body">
    <div class="tabs">
      <div class="tab active" onclick="filterByStatus(this,'')">All</div>
      <div class="tab" onclick="filterByStatus(this,'online')">Online</div>
      <div class="tab" onclick="filterByStatus(this,'offline')">Offline</div>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Device</th><th>Platform</th><th>OS</th><th>IP</th><th>CPU</th><th>RAM</th><th>Disk</th><th>Battery</th><th>Agent</th><th>Last Seen</th><th></th></tr></thead>
        <tbody id="deviceTable"><tr><td colspan="11" style="text-align:center;padding:30px;color:var(--text3)">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• TASKS â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-tasks">
  <div class="topbar">
    <div>
      <div class="topbar-title">Tasks</div>
      <div class="topbar-sub">Scheduled and recurring automation</div>
    </div>
    <div class="topbar-actions">
      <button class="btn btn-ghost btn-sm" onclick="loadTasks()">â†» Refresh</button>
      <button class="btn btn-primary btn-sm" onclick="openModal('modalTask')">ï¼‹ New Task</button>
    </div>
  </div>
  <div class="page-body">
    <div class="tabs">
      <div class="tab active" onclick="filterTasks(this,'')">All</div>
      <div class="tab" onclick="filterTasks(this,'pending')">Pending</div>
      <div class="tab" onclick="filterTasks(this,'running')">Running</div>
      <div class="tab" onclick="filterTasks(this,'done')">Done</div>
      <div class="tab" onclick="filterTasks(this,'failed')">Failed</div>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Task Name</th><th>Trigger</th><th>Target</th><th>Status</th><th>Results</th><th>Created</th><th>Actions</th></tr></thead>
        <tbody id="taskTable"><tr><td colspan="7" style="text-align:center;padding:30px;color:var(--text3)">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPT LIBRARY â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-scripts">
  <div class="topbar">
    <div>
      <div class="topbar-title">Script Library</div>
      <div class="topbar-sub">Reusable scripts â€” click to run, edit, or schedule</div>
    </div>
    <div class="topbar-actions">
      <select class="form-select" style="width:140px" id="scriptCatFilter" onchange="filterScripts()">
        <option value="">All Categories</option>
        <option value="Maintenance">Maintenance</option>
        <option value="Monitoring">Monitoring</option>
        <option value="Security">Security</option>
        <option value="Network">Network</option>
        <option value="Custom">Custom</option>
      </select>
      <select class="form-select" style="width:130px" id="scriptPlatFilter" onchange="filterScripts()">
        <option value="">All Platforms</option>
        <option value="windows">Windows</option>
        <option value="linux">Linux</option>
        <option value="android">Android</option>
        <option value="all">Cross-platform</option>
      </select>
      <button class="btn btn-ghost btn-sm" onclick="seedScripts()">â¬‡ Load Built-ins</button>
      <button class="btn btn-primary btn-sm" onclick="openModal('modalScript')">ï¼‹ New Script</button>
    </div>
  </div>
  <div class="page-body">
    <div id="scriptGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px">
      <div style="color:var(--text3);font-size:12px;padding:30px;text-align:center;grid-column:1/-1">Loading scripts...</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• INVENTORY â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-inventory">
  <div class="topbar">
    <div>
      <div class="topbar-title">Inventory</div>
      <div class="topbar-sub">Asset tracking â€” scan tag or search by ID</div>
    </div>
    <div class="topbar-actions">
      <div class="search-bar">
        <span style="color:var(--text3)">âŒ•</span>
        <input type="text" placeholder="Search by tag, name, model..." id="assetSearch" oninput="searchAssets()">
      </div>
      <button class="btn btn-ghost btn-sm" onclick="openModal('modalScan')">ğŸ“· Scan Tag</button>
      <button class="btn btn-primary btn-sm" onclick="openModal('modalAsset')">ï¼‹ Add Asset</button>
    </div>
  </div>
  <div class="page-body">
    <div class="table-wrap">
      <table>
        <thead><tr><th>Asset Tag</th><th>Name</th><th>Model</th><th>Owner</th><th>Location</th><th>Category</th><th>Status</th><th>Device</th><th></th></tr></thead>
        <tbody id="assetTable"><tr><td colspan="9" style="text-align:center;padding:30px;color:var(--text3)">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• DEPLOY â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-deploy">
  <div class="topbar">
    <div>
      <div class="topbar-title">Deploy Agents</div>
      <div class="topbar-sub">Build and distribute pre-configured installers</div>
    </div>
  </div>
  <div class="page-body">
    <div class="card" style="margin-bottom:20px">
      <div class="card-label" style="margin-bottom:14px">Build Configuration</div>
      <div class="form-grid form-grid-3">
        <div class="form-group">
          <label class="form-label">Local IP</label>
          <input class="form-input" id="buildLocalIP" value="192.168.5.199">
          <div style="font-size:11px;color:var(--text3);margin-top:3px">LAN â€” on-site</div>
        </div>
        <div class="form-group">
          <label class="form-label">VPN IP</label>
          <input class="form-input" id="buildVpnIP" value="100.125.120.81">
          <div style="font-size:11px;color:var(--text3);margin-top:3px">Netbird â€” remote</div>
        </div>
        <div class="form-group">
          <label class="form-label">Port</label>
          <input class="form-input" id="buildPort" value="8000">
        </div>
      </div>
      <div style="background:var(--bg3);border-radius:6px;padding:10px 12px;font-size:12px;color:var(--text3);font-family:var(--mono)">
        Agents try Local IP â†’ fall back to VPN â†’ re-test both weekly. Token baked in automatically.
      </div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
      <div class="card">
        <div style="font-size:24px;margin-bottom:10px">ğŸªŸ</div>
        <div class="card-label" style="margin-bottom:6px">Windows Agent</div>
        <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">
          Silent .msi installer Â· Deploy via WSUS/SCCM/Intune Â· Auto-starts on boot Â· Log at C:\ProgramData\SovereignRMM\agent.log
        </div>
        <div class="form-group">
          <label class="form-label">Auto-update</label>
          <div class="toggle" id="toggleAutoWin" onclick="toggleSetting('auto_update_win',this)"></div>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="buildAgent('windows')" id="btnWin">â¬‡ Build Windows .msi</button>
        <div id="winStatus" style="margin-top:10px;font-size:12px;display:none"></div>
      </div>

      <div class="card">
        <div style="font-size:24px;margin-bottom:10px">ğŸ§</div>
        <div class="card-label" style="margin-bottom:6px">Linux Agent (Ubuntu)</div>
        <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">
          .deb package Â· Installs as systemd service Â· Auto-start on boot
        </div>
        <div class="form-group">
          <label class="form-label">Auto-update</label>
          <div class="toggle" id="toggleAutoLnx" onclick="toggleSetting('auto_update_lnx',this)"></div>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="buildAgent('linux')" id="btnLnx">â¬‡ Build Linux .deb</button>
        <div id="linuxStatus" style="margin-top:10px;font-size:12px;display:none"></div>
      </div>

      <div class="card">
        <div style="font-size:24px;margin-bottom:10px">ğŸ¤–</div>
        <div class="card-label" style="margin-bottom:6px">Android Agent</div>
        <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">
          Termux script or APK Â· Battery-aware Â· LineageOS / AOSP
        </div>
        <div class="form-group">
          <label class="form-label">Auto-update</label>
          <div class="toggle" id="toggleAutoAdr" onclick="toggleSetting('auto_update_adr',this)"></div>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="buildAgent('android')" id="btnAdr">â¬‡ Build Android Package</button>
        <div id="androidStatus" style="margin-top:10px;font-size:12px;display:none"></div>
      </div>
    </div>

    <div class="card" style="margin-top:20px">
      <div class="card-label" style="margin-bottom:12px">Current Agent Versions on Server</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
        <div>
          <div class="form-label">Windows Version</div>
          <input class="form-input" id="verWin" placeholder="2.0.0" oninput="saveSetting('agent_version_win',this.value)">
        </div>
        <div>
          <div class="form-label">Linux Version</div>
          <input class="form-input" id="verLnx" placeholder="2.0.0" oninput="saveSetting('agent_version_lnx',this.value)">
        </div>
        <div>
          <div class="form-label">Android Version</div>
          <input class="form-input" id="verAdr" placeholder="2.0.0" oninput="saveSetting('agent_version_adr',this.value)">
        </div>
      </div>
      <div style="margin-top:10px;font-size:12px;color:var(--text3)">Devices will be notified of updates on next check-in. Auto-update pushes it immediately when device is online.</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• POLICIES â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-policies">
  <div class="topbar">
    <div><div class="topbar-title">Check-in Policies</div><div class="topbar-sub">Battery-adaptive heartbeat intervals</div></div>
    <div class="topbar-actions"><button class="btn btn-primary btn-sm" onclick="savePolicies()">Save Policies</button></div>
  </div>
  <div class="page-body">
    <div class="card">
      <div class="card-label" style="margin-bottom:16px">Default Global Policy</div>
      <div class="form-grid form-grid-2">
        <div class="form-group"><label class="form-label">Plugged In (seconds)</label><input class="form-input" id="pol_plugged" type="number" value="30"></div>
        <div class="form-group"><label class="form-label">Battery 80-100%</label><input class="form-input" id="pol_100_80" type="number" value="60"></div>
        <div class="form-group"><label class="form-label">Battery 50-79%</label><input class="form-input" id="pol_79_50" type="number" value="180"></div>
        <div class="form-group"><label class="form-label">Battery 20-49%</label><input class="form-input" id="pol_49_20" type="number" value="300"></div>
        <div class="form-group"><label class="form-label">Battery 10-19%</label><input class="form-input" id="pol_19_10" type="number" value="600"></div>
        <div class="form-group"><label class="form-label">Battery 0-9%</label><input class="form-input" id="pol_9_0" type="number" value="900"></div>
        <div class="form-group"><label class="form-label">Low Battery Alert %</label><input class="form-input" id="pol_alert" type="number" value="15"></div>
        <div class="form-group"><label class="form-label">Disk Scan Interval (hours)</label><input class="form-input" id="pol_disk" type="number" value="168"></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETTINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-settings">
  <div class="topbar">
    <div><div class="topbar-title">Settings</div><div class="topbar-sub">All server configuration â€” no file editing needed</div></div>
    <div class="topbar-actions"><button class="btn btn-primary btn-sm" onclick="saveAllSettings()">Save All Settings</button></div>
  </div>
  <div class="page-body" id="settingsBody">
    <div style="color:var(--text3);text-align:center;padding:40px">Loading settings...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• NETBIRD â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-netbird">
  <div class="topbar">
    <div><div class="topbar-title">Netbird VPN</div><div class="topbar-sub">Self-hosted peer-to-peer VPN</div></div>
  </div>
  <div class="page-body">
    <div class="cards-row" style="grid-template-columns:1fr 1fr">
      <div class="card"><div class="card-label">Management Server</div><div id="nbMgmtStatus" style="font-size:13px;margin-top:8px;font-family:var(--mono);color:var(--text3)">Checking...</div></div>
      <div class="card"><div class="card-label">Connected Peers</div><div class="card-value accent" id="nbPeerCount">â€”</div></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGS â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-logs">
  <div class="topbar">
    <div><div class="topbar-title">Logs</div></div>
    <div class="topbar-actions"><button class="btn btn-ghost btn-sm" onclick="loadLogs()">â†» Refresh</button></div>
  </div>
  <div class="page-body">
    <div class="table-wrap">
      <table>
        <thead><tr><th>Time</th><th>Device</th><th>Level</th><th>Message</th></tr></thead>
        <tbody id="logsTable"><tr><td colspan="4" style="text-align:center;padding:30px;color:var(--text3)">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOCKDOWN â•â•â•â•â•â•â•â•â•â•â•â•â•â• --><div class="page" id="page-lockdown">  <div class="topbar">    <div><div class="topbar-title">Lockdown Mode</div><div class="topbar-sub">Block all user logins â€” emergency security measure</div></div>    <div class="topbar-actions" id="lockdownActions"></div>  </div>  <div class="page-body">    <div id="lockdownStatusCard" class="card" style="margin-bottom:20px;border-color:var(--border)">      <div style="display:flex;align-items:center;justify-content:space-between">        <div>          <div class="card-label">Current Status</div>          <div id="lockdownStatusText" style="font-size:22px;font-weight:700;margin-top:8px;font-family:var(--mono)">Loading...</div>        </div>        <div id="lockdownToggleArea"></div>      </div>    </div>    <div style="margin-bottom:20px" id="lockdownReasonArea" style="display:none">      <div class="form-group">        <label class="form-label">Reason (optional)</label>        <input class="form-input" id="lockdownReason" placeholder="e.g. Security incident, maintenance...">      </div>    </div>    <div class="section-header"><div class="section-title">Lockdown History</div></div>    <div class="table-wrap">      <table>        <thead><tr><th>Time</th><th>Action</th><th>Reason</th><th>By</th></tr></thead>        <tbody id="lockdownHistoryTable"><tr><td colspan="4" style="text-align:center;padding:20px;color:var(--text3)">Loading...</td></tr></tbody>      </table>    </div>  </div></div><!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• WAKE ON LAN â•â•â•â•â•â•â•â•â•â•â•â•â•â• --><div class="page" id="page-wol">  <div class="topbar">    <div><div class="topbar-title">Wake on LAN</div><div class="topbar-sub">Power on devices remotely via magic packet</div></div>    <div class="topbar-actions">      <button class="btn btn-ghost btn-sm" onclick="openModal('modalWolManual')">âš¡ Wake by MAC</button>    </div>  </div>  <div class="page-body">    <div class="card" style="margin-bottom:20px">      <div class="card-label" style="margin-bottom:4px">How it works</div>      <div style="font-size:12px;color:var(--text3);line-height:1.7">The server sends a magic packet to the device's MAC address over UDP port 9. Device must have Wake on LAN enabled in BIOS/UEFI and be on the same subnet as the server. The agent automatically reports its MAC on first check-in.</div>    </div>    <div class="table-wrap">      <table>        <thead><tr><th>Device</th><th>Platform</th><th>MAC Address</th><th>Status</th><th>Actions</th></tr></thead>        <tbody id="wolDeviceTable"><tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text3)">Loading...</td></tr></tbody>      </table>    </div>    <div class="section-header" style="margin-top:20px"><div class="section-title">WoL History</div></div>    <div class="table-wrap">      <table>        <thead><tr><th>Time</th><th>Target</th><th>MAC</th><th>By</th></tr></thead>        <tbody id="wolHistoryTable"><tr><td colspan="4" style="text-align:center;padding:20px;color:var(--text3)">Loading...</td></tr></tbody>      </table>    </div>  </div></div><!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• ASSET TAG GENERATOR â•â•â•â•â•â•â•â•â•â•â•â•â•â• --><div class="page" id="page-asset-tags">  <div class="topbar">    <div><div class="topbar-title">Asset Tag Generator</div><div class="topbar-sub">Generate printable labels matching your existing format</div></div>    <div class="topbar-actions">      <input type="file" id="logoUpload" accept="image/png,image/jpeg" style="display:none" onchange="handleLogoUpload(event)">      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('logoUpload').click()">ğŸ“· Upload Logo</button>      <button class="btn btn-primary btn-sm" onclick="printTags()">ğŸ–¨ Print / Save PDF</button>    </div>  </div>  <div class="page-body">    <div style="display:grid;grid-template-columns:320px 1fr;gap:20px">      <!-- CONTROLS -->      <div>        <div class="card" style="margin-bottom:16px">          <div class="card-label" style="margin-bottom:12px">Tag Template</div>          <div class="form-group"><label class="form-label">Owner Text</label><input class="form-input" id="tplOwner" value="Property of:Nelson.B" oninput="refreshTagPreview()"></div>          <div class="form-group"><label class="form-label">Reward Text</label><input class="form-input" id="tplReward" value="Reward may be issued if found" oninput="refreshTagPreview()"></div>          <div class="form-group"><label class="form-label">Found Text</label><input class="form-input" id="tplFound" value="scan if found: report device here or go to" oninput="refreshTagPreview()"></div>          <div class="form-group"><label class="form-label">QR URL (Google Form)</label><input class="form-input" id="tplQrUrl" value="https://forms.gle/R6vqyzG7QQXQl36Su7" oninput="refreshTagPreview()"></div>          <div class="form-group"><label class="form-label">Background Color</label><input class="form-input" id="tplBg" type="color" value="#000000" oninput="refreshTagPreview()"></div>          <div class="form-group"><label class="form-label">Text Color</label><input class="form-input" id="tplFg" type="color" value="#ffffff" oninput="refreshTagPreview()"></div>        </div>        <div class="card" style="margin-bottom:16px">          <div class="card-label" style="margin-bottom:12px">Generate Tags</div>          <div class="form-group"><label class="form-label">Asset Tag Format</label>            <div style="display:flex;gap:8px">              <input class="form-input" id="tagYear" value="2026" style="width:70px">              <span style="line-height:36px;color:var(--text3)">-</span>              <input class="form-input" id="tagStart" type="number" value="3" style="width:70px">              <span style="line-height:36px;color:var(--text3)">to</span>              <input class="form-input" id="tagEnd" type="number" value="5" style="width:70px">            </div>            <div style="font-size:11px;color:var(--text3);margin-top:3px;font-family:var(--mono)">Generates tags like 2026-003, 2026-004...</div>          </div>          <div class="form-group"><label class="form-label">Or paste asset list (one per line)</label>            <textarea class="form-textarea" id="tagCustomList" rows="3" placeholder="lat-3310&#10;desktop-02&#10;server-01" oninput="refreshTagPreview()"></textarea>          </div>          <button class="btn btn-primary" style="width:100%" onclick="generateTagBatch()">Generate Batch</button>        </div>      </div>      <!-- PREVIEW -->      <div>        <div class="section-header"><div class="section-title">Preview</div><div id="tagPreviewCount" style="font-size:12px;color:var(--text3)"></div></div>        <div id="tagPreviewGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:16px">          <!-- Tags render here -->        </div>        <div id="printArea" style="display:none"></div>      </div>    </div>  </div></div><!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• EMAIL ALERTS â•â•â•â•â•â•â•â•â•â•â•â•â•â• --><div class="page" id="page-email">  <div class="topbar">    <div><div class="topbar-title">Email Alerts</div><div class="topbar-sub">SMTP configuration and alert templates</div></div>    <div class="topbar-actions">      <button class="btn btn-ghost btn-sm" onclick="seedEmailTemplates()">Load Templates</button>      <button class="btn btn-ghost btn-sm" onclick="testEmail()">ğŸ“§ Send Test</button>      <button class="btn btn-primary btn-sm" onclick="saveEmailSettings()">Save SMTP</button>    </div>  </div>  <div class="page-body">    <div class="card" style="margin-bottom:20px">      <div class="card-label" style="margin-bottom:14px">SMTP Configuration</div>      <div class="form-grid form-grid-2">        <div class="form-group"><label class="form-label">SMTP Host</label><input class="form-input" id="smtpHost" placeholder="smtp.gmail.com"></div>        <div class="form-group"><label class="form-label">SMTP Port</label><input class="form-input" id="smtpPort" value="587"></div>        <div class="form-group"><label class="form-label">Username</label><input class="form-input" id="smtpUser" placeholder="you@gmail.com"></div>        <div class="form-group"><label class="form-label">Password / App Password</label><input class="form-input" id="smtpPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>        <div class="form-group"><label class="form-label">Alert Recipient Email</label><input class="form-input" id="alertEmail" placeholder="admin@example.com"></div>      </div>    </div>    <div class="section-header"><div class="section-title">Alert Templates</div></div>    <div id="emailTemplates" style="display:flex;flex-direction:column;gap:12px">      <div style="color:var(--text3);text-align:center;padding:20px">Click "Load Templates" to initialize default alert templates</div>    </div>  </div></div><!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• BACKUP / RESTORE â•â•â•â•â•â•â•â•â•â•â•â•â•â• --><div class="page" id="page-backup">  <div class="topbar">    <div><div class="topbar-title">Backup &amp; Restore</div><div class="topbar-sub">Full server import/export â€” devices, assets, tasks, scripts, settings</div></div>  </div>  <div class="page-body">    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">      <div class="card">        <div style="font-size:28px;margin-bottom:12px">ğŸ“¦</div>        <div class="card-label" style="margin-bottom:8px">Export Backup</div>        <div style="font-size:12px;color:var(--text3);margin-bottom:16px;line-height:1.7">Downloads a ZIP file containing all your data â€” devices, assets, tasks, scripts, settings, policies, and more. Use this to migrate servers or create a snapshot.</div>        <button class="btn btn-primary" style="width:100%" onclick="exportBackup()">â¬‡ Download Backup ZIP</button>      </div>      <div class="card">        <div style="font-size:28px;margin-bottom:12px">ğŸ“‚</div>        <div class="card-label" style="margin-bottom:8px">Import Backup</div>        <div style="font-size:12px;color:var(--text3);margin-bottom:16px;line-height:1.7">Upload a previously exported ZIP or JSON backup. Existing records are preserved â€” import only adds missing ones. Does not delete anything.</div>        <input type="file" id="backupImportFile" accept=".zip,.json" style="display:none" onchange="importBackup(event)">        <button class="btn btn-ghost" style="width:100%" onclick="document.getElementById('backupImportFile').click()">â¬† Choose Backup File</button>        <div id="importStatus" style="margin-top:10px;font-size:12px"></div>      </div>    </div>  </div></div>
</div><!-- .main -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- New Task Modal -->
<div class="modal-overlay" id="modalTask">
  <div class="modal" style="width:640px">
    <div class="modal-header">
      <div class="modal-title">New Task</div>
      <button class="modal-close" onclick="closeModal('modalTask')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-grid form-grid-2">
        <div class="form-group" style="grid-column:1/-1">
          <label class="form-label">Task Name</label>
          <input class="form-input" id="taskName" placeholder="e.g. Weekly Disk Cleanup">
        </div>
        <div class="form-group">
          <label class="form-label">Script Type</label>
          <select class="form-select" id="taskScriptType">
            <option value="powershell">PowerShell (Windows)</option>
            <option value="bash">Bash (Linux/Android)</option>
            <option value="python">Python (All)</option>
            <option value="cmd">CMD (Windows)</option>
            <option value="adb">ADB (Android)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Target Platform</label>
          <select class="form-select" id="taskPlatform">
            <option value="all">All Platforms</option>
            <option value="windows">Windows Only</option>
            <option value="linux">Linux Only</option>
            <option value="android">Android Only</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Target Devices</label>
          <select class="form-select" id="taskTargetType" onchange="updateTargetUI()">
            <option value="all">All Online Devices</option>
            <option value="device">Specific Device</option>
            <option value="group">Device Group</option>
          </select>
        </div>
        <div class="form-group" id="taskTargetDeviceGroup" style="display:none">
          <label class="form-label">Select Device</label>
          <select class="form-select" id="taskTargetId"></select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Script</label>
        <textarea class="form-textarea" id="taskScript" rows="6" placeholder="# Your script here..."></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Trigger</label>
        <select class="form-select" id="taskTrigger" onchange="updateTriggerUI()">
          <option value="now">Run Now</option>
          <option value="once">Run Once at Scheduled Time</option>
          <option value="interval">Recurring â€” Every X Hours/Minutes</option>
          <option value="cron">Recurring â€” Cron Schedule</option>
          <option value="event">Event-based</option>
        </select>
      </div>
      <div id="triggerOnce" style="display:none">
        <div class="form-group">
          <label class="form-label">Run At</label>
          <input class="form-input" id="taskScheduledAt" type="datetime-local">
          <div style="font-size:11px;color:var(--text3);margin-top:4px;font-family:var(--mono)">Agent will store this locally and run it even if the server is offline. 5 min before run time it checks if task was cancelled.</div>
        </div>
      </div>
      <div id="triggerInterval" style="display:none">
        <div class="form-grid form-grid-2">
          <div class="form-group">
            <label class="form-label">Every</label>
            <input class="form-input" id="taskInterval" type="number" placeholder="e.g. 24" min="1">
          </div>
          <div class="form-group">
            <label class="form-label">Unit</label>
            <select class="form-select" id="taskIntervalUnit">
              <option value="60">Minutes</option>
              <option value="3600" selected>Hours</option>
              <option value="86400">Days</option>
            </select>
          </div>
        </div>
      </div>
      <div id="triggerCron" style="display:none">
        <div class="form-group">
          <label class="form-label">Cron Expression</label>
          <input class="form-input" id="taskCron" placeholder="0 5 * * 1  (every Monday at 5am)" style="font-family:var(--mono)">
          <div style="font-size:11px;color:var(--text3);margin-top:4px">Format: minute hour day month weekday</div>
        </div>
      </div>
      <div id="triggerEvent" style="display:none">
        <div class="form-group">
          <label class="form-label">Run On Event</label>
          <select class="form-select" id="taskEvent">
            <option value="startup">System Startup</option>
            <option value="login">User Login</option>
            <option value="network_change">Network Change Detected</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalTask')">Cancel</button>
      <button class="btn btn-primary" onclick="createTask()">Create Task</button>
    </div>
  </div>
</div>

<!-- New Script Modal -->
<div class="modal-overlay" id="modalScript">
  <div class="modal" style="width:600px">
    <div class="modal-header">
      <div class="modal-title">New Script</div>
      <button class="modal-close" onclick="closeModal('modalScript')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-grid form-grid-2">
        <div class="form-group" style="grid-column:1/-1">
          <label class="form-label">Script Name</label>
          <input class="form-input" id="scriptName" placeholder="e.g. Clear Temp Files">
        </div>
        <div class="form-group" style="grid-column:1/-1">
          <label class="form-label">Description</label>
          <input class="form-input" id="scriptDesc" placeholder="What does this script do?">
        </div>
        <div class="form-group">
          <label class="form-label">Category</label>
          <select class="form-select" id="scriptCategory">
            <option>Maintenance</option><option>Monitoring</option>
            <option>Security</option><option>Network</option><option>Custom</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Platform</label>
          <select class="form-select" id="scriptPlatform">
            <option value="windows">Windows</option>
            <option value="linux">Linux</option>
            <option value="android">Android</option>
            <option value="all">All Platforms</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Script Type</label>
          <select class="form-select" id="scriptType">
            <option value="powershell">PowerShell</option>
            <option value="bash">Bash</option>
            <option value="python">Python</option>
            <option value="cmd">CMD</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Script Body</label>
        <textarea class="form-textarea" id="scriptBody" rows="8" placeholder="# Script content..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalScript')">Cancel</button>
      <button class="btn btn-primary" onclick="saveScript()">Save Script</button>
    </div>
  </div>
</div>

<!-- Asset Modal -->
<div class="modal-overlay" id="modalAsset">
  <div class="modal" style="width:580px">
    <div class="modal-header">
      <div class="modal-title" id="assetModalTitle">Add Asset</div>
      <button class="modal-close" onclick="closeModal('modalAsset')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-grid form-grid-2">
        <div class="form-group">
          <label class="form-label">Asset Tag</label>
          <input class="form-input" id="assetTag" placeholder="e.g. 2026-002" style="font-family:var(--mono)">
        </div>
        <div class="form-group">
          <label class="form-label">Device Name</label>
          <input class="form-input" id="assetName" placeholder="e.g. lat-3310">
        </div>
        <div class="form-group">
          <label class="form-label">Model</label>
          <input class="form-input" id="assetModel" placeholder="e.g. dell-lat-3310">
        </div>
        <div class="form-group">
          <label class="form-label">Owner</label>
          <input class="form-input" id="assetOwner" placeholder="e.g. Nelson.B">
        </div>
        <div class="form-group">
          <label class="form-label">Location</label>
          <input class="form-input" id="assetLocation" placeholder="e.g. Office A">
        </div>
        <div class="form-group">
          <label class="form-label">Category</label>
          <select class="form-select" id="assetCategory">
            <option>Laptop</option><option>Desktop</option><option>Phone</option>
            <option>Tablet</option><option>Server</option><option>Other</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Serial Number</label>
          <input class="form-input" id="assetSerial" style="font-family:var(--mono)">
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-select" id="assetStatus">
            <option value="active">Active</option>
            <option value="retired">Retired</option>
            <option value="lost">Lost</option>
            <option value="stolen">Stolen</option>
          </select>
        </div>
        <div class="form-group" style="grid-column:1/-1">
          <label class="form-label">Google Form URL (existing QR link)</label>
          <input class="form-input" id="assetFormUrl" placeholder="https://forms.gle/..." style="font-family:var(--mono)">
        </div>
        <div class="form-group" style="grid-column:1/-1">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" id="assetNotes" rows="3"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalAsset')">Cancel</button>
      <button class="btn btn-primary" onclick="saveAsset()">Save Asset</button>
    </div>
  </div>
</div>

<!-- Scan Tag Modal -->
<div class="modal-overlay" id="modalScan">
  <div class="modal" style="width:460px">
    <div class="modal-header">
      <div class="modal-title">Scan Asset Tag</div>
      <button class="modal-close" onclick="closeModal('modalScan')">Ã—</button>
    </div>
    <div class="modal-body">
      <div style="font-size:13px;color:var(--text2);margin-bottom:14px;line-height:1.6">
        Type or paste the asset tag number from the label (e.g. <span style="font-family:var(--mono);color:var(--accent)">2026-002</span>) to look up the device record.
      </div>
      <div class="form-group">
        <label class="form-label">Asset Tag / Device Name / Serial</label>
        <input class="form-input" id="scanInput" placeholder="2026-002" style="font-family:var(--mono);font-size:16px;text-align:center"
               onkeydown="if(event.key==='Enter')scanLookup()">
      </div>
      <button class="btn btn-primary" style="width:100%" onclick="scanLookup()">Look Up</button>
      <div id="scanResult" style="margin-top:14px"></div>
    </div>
  </div>
</div>

<!-- Task Results Panel -->
<div class="panel-overlay" id="panelResultsOverlay" onclick="closePanel('panelResults',this)">
  <div class="panel" id="panelResults">
    <div class="panel-header">
      <div class="panel-title" id="panelResultsTitle">Task Results</div>
      <button class="panel-close" onclick="closePanel('panelResults')">Ã—</button>
    </div>
    <div id="panelResultsBody">Loading...</div>
  </div>
</div>

<!-- Device Detail Panel -->
<div class="panel-overlay" id="panelDeviceOverlay" onclick="closePanel('panelDevice',this)">
  <div class="panel" id="panelDevice">
    <div class="panel-header">
      <div class="panel-title" id="panelDeviceTitle">Device</div>
      <button class="panel-close" onclick="closePanel('panelDevice')">Ã—</button>
    </div>
    <div id="panelDeviceBody">Loading...</div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let authToken = '';
let ws = null;
let wsReconnectTimer = null;
let wsDelay = 2000;
let allDevices = [], allTasks = [], allScripts = [], allAssets = [];
let deviceStatusFilter = '';
let taskStatusFilter = '';
let editingAssetId = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin() {
  const u = document.getElementById('loginUser').value;
  const p = document.getElementById('loginPass').value;
  try {
    const res = await api('/api/auth/login', 'POST', {username: u, password: p}, true);
    if (res.token) {
      authToken = res.token;
      document.getElementById('loginScreen').style.display = 'none';
      initApp();
    }
  } catch(e) {
    document.getElementById('loginError').textContent = 'Invalid credentials';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(path, method='GET', body=null, noAuth=false) {
  const headers = {'Content-Type':'application/json'};
  if (!noAuth && authToken) headers['Authorization'] = `Bearer ${authToken}`;
  const opts = {method, headers};
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(path, opts);
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initApp() {
  connectWebSocket();
  refreshDashboard();
  loadDevices();
  loadTasks();
  loadScripts();
  loadAssets();
  loadSettings();
  loadPolicies();
  loadDeploySettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBSOCKET â€” fixed with exponential backoff
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function connectWebSocket() {
  const dot = document.getElementById('wsDot');
  const status = document.getElementById('wsStatus');
  dot.className = 'ws-dot reconnecting';
  status.textContent = 'Connecting...';

  if (ws) { try { ws.close(); } catch(e){} }
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws/dashboard`);

  ws.onopen = () => {
    dot.className = 'ws-dot connected';
    status.textContent = 'Live';
    wsDelay = 2000;
    clearTimeout(wsReconnectTimer);
  };

  ws.onmessage = (e) => {
    try { handleWsMessage(JSON.parse(e.data)); } catch(err) {}
  };

  ws.onclose = ws.onerror = () => {
    dot.className = 'ws-dot';
    status.textContent = 'Reconnecting...';
    wsDelay = Math.min(wsDelay * 1.5, 30000);
    clearTimeout(wsReconnectTimer);
    wsReconnectTimer = setTimeout(connectWebSocket, wsDelay);
  };
}

function handleWsMessage(msg) {
  switch(msg.type) {
    case 'connected':
      break;
    case 'heartbeat':
      updateDeviceLive(msg.device_id, msg.data);
      break;
    case 'device_online':
    case 'device_offline':
      loadDevices();
      refreshDashboard();
      break;
    case 'task_output':
      appendTaskOutput(msg.task_id, msg.device_id, msg.output, msg.progress);
      break;
    case 'task_complete':
      onTaskComplete(msg);
      break;
    case 'disk_scan':
      // handled in device detail panel if open
      break;
  }
}

function updateDeviceLive(deviceId, data) {
  allDevices = allDevices.map(d => d.device_id === deviceId ? {...d, ...data, status:'online'} : d);
  renderDeviceTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name)?.classList.add('active');
  event?.currentTarget?.classList.add('active');
  if (name === 'tasks')     loadTasks();
  if (name === 'scripts')   loadScripts();
  if (name === 'inventory') loadAssets();
  if (name === 'settings')  loadSettings();
  if (name === 'logs')      loadLogs();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function refreshDashboard() {
  try {
    const summary = await api('/api/dashboard/summary');
    document.getElementById('statTotal').textContent  = summary.total_devices;
    document.getElementById('statOnline').textContent = summary.online_devices;
    document.getElementById('statOffline').textContent= summary.offline_devices;
    document.getElementById('statTasks').textContent  = summary.tasks_pending;
    document.getElementById('dashLastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();
    renderDashDevices();
    loadRecentLogs();
  } catch(e) {}
}

function renderDashDevices() {
  const online = allDevices.filter(d => d.status === 'online').slice(0, 10);
  const tbody = document.getElementById('dashDeviceTable');
  if (!online.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text3)">No devices online</td></tr>'; return; }
  tbody.innerHTML = online.map(d => `
    <tr onclick="openDevicePanel('${d.device_id}')">
      <td><span style="font-weight:500">${d.label||d.hostname}</span></td>
      <td>${platformChip(d.platform)}</td>
      <td>${gauge(d.cpu_percent)}</td>
      <td>${gauge(d.ram_percent)}</td>
      <td>${batteryDisplay(d.battery_level, d.battery_charging)}</td>
      <td style="color:var(--text3);font-size:12px;font-family:var(--mono)">${timeAgo(d.last_seen)}</td>
    </tr>`).join('');
}

async function loadRecentLogs() {
  try {
    const logs = await api('/api/dashboard/logs?limit=15');
    const el = document.getElementById('recentLogs');
    el.innerHTML = logs.slice(0,10).map(l => `
      <div style="padding:8px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;font-size:12px">
        <div style="display:flex;justify-content:space-between;margin-bottom:3px">
          <span style="color:var(--text3);font-family:var(--mono)">${l.hostname||'system'}</span>
          <span class="badge badge-${l.level==='error'?'offline':l.level==='warning'?'warning':'info'}" style="font-size:10px">${l.level}</span>
        </div>
        <div style="color:var(--text2)">${l.message.substring(0,80)}</div>
      </div>`).join('');
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEVICES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDevices() {
  try {
    allDevices = await api('/api/dashboard/devices/');
    renderDeviceTable();
    renderDashDevices();
    document.getElementById('deviceCount').textContent = `${allDevices.length} devices`;
  } catch(e) {}
}

function filterByStatus(el, status) {
  deviceStatusFilter = status;
  document.querySelectorAll('#page-devices .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderDeviceTable();
}

function filterDevices() { renderDeviceTable(); }

function renderDeviceTable() {
  const search   = (document.getElementById('deviceSearch')?.value || '').toLowerCase();
  const platform = document.getElementById('platformFilter')?.value || '';
  let devices = allDevices.filter(d => {
    if (deviceStatusFilter && d.status !== deviceStatusFilter) return false;
    if (platform && d.platform !== platform) return false;
    if (search && !(d.hostname+d.label+d.ip_address).toLowerCase().includes(search)) return false;
    return true;
  });
  const tbody = document.getElementById('deviceTable');
  if (!devices.length) { tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:30px;color:var(--text3)">No devices found</td></tr>'; return; }
  tbody.innerHTML = devices.map(d => `
    <tr onclick="openDevicePanel('${d.device_id}')">
      <td>
        <div style="font-weight:500">${d.label||d.hostname}</div>
        <div style="font-size:11px;color:var(--text3);font-family:var(--mono)">${d.device_id.substring(0,8)}</div>
      </td>
      <td>${platformChip(d.platform)}</td>
      <td style="font-size:12px;color:var(--text2)">${d.os_info||'â€”'}</td>
      <td style="font-family:var(--mono);font-size:12px">${d.ip_address||'â€”'}</td>
      <td style="width:80px">${miniGauge(d.cpu_percent,'#00e5ff')}</td>
      <td style="width:80px">${miniGauge(d.ram_percent,'#00e676')}</td>
      <td style="width:80px">${miniGauge(d.disk_percent,'#ff9100')}</td>
      <td>${batteryDisplay(d.battery_level, d.battery_charging)}</td>
      <td style="font-family:var(--mono);font-size:11px;color:${d.agent_version?'var(--text3)':'var(--red)'}">${d.agent_version||'?'}</td>
      <td style="color:var(--text3);font-size:12px;font-family:var(--mono)">${timeAgo(d.last_seen)}</td>
      <td onclick="event.stopPropagation()">
        <div style="display:flex;gap:4px">
          <button class="btn btn-ghost btn-sm" onclick="quickTask('${d.device_id}')">Run</button>
          <button class="btn btn-ghost btn-sm btn-icon" onclick="scanDisk('${d.device_id}')">ğŸ’¾</button>
        </div>
      </td>
    </tr>`).join('');
}

function openDevicePanel(deviceId) {
  const d = allDevices.find(x => x.device_id === deviceId);
  if (!d) return;
  document.getElementById('panelDeviceTitle').textContent = d.label || d.hostname;
  document.getElementById('panelDeviceBody').innerHTML = `
    <div class="form-grid form-grid-2" style="gap:10px;margin-bottom:16px">
      <div class="card"><div class="card-label">Status</div><div style="margin-top:6px">${statusBadge(d.status)}</div></div>
      <div class="card"><div class="card-label">Platform</div><div style="margin-top:6px">${platformChip(d.platform)}</div></div>
      <div class="card"><div class="card-label">IP Address</div><div style="font-family:var(--mono);font-size:13px;margin-top:6px">${d.ip_address||'â€”'}</div></div>
      <div class="card"><div class="card-label">Agent Version</div><div style="font-family:var(--mono);font-size:13px;margin-top:6px">${d.agent_version||'â€”'}</div></div>
    </div>
    <div class="card" style="margin-bottom:14px">
      <div class="card-label" style="margin-bottom:12px">Live Metrics</div>
      <div class="gauge-row" style="gap:10px">
        ${metricRow('CPU',d.cpu_percent,'#00e5ff')}
        ${metricRow('RAM',d.ram_percent,'#00e676')}
        ${metricRow('Disk',d.disk_percent,'#ff9100')}
      </div>
      ${d.battery_level!=null?`<div style="margin-top:12px;font-size:13px">ğŸ”‹ ${d.battery_level}% ${d.battery_charging?'âš¡ Charging':''}</div>`:''}
    </div>
    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
      <button class="btn btn-primary btn-sm" onclick="quickTask('${d.device_id}')">â–¶ Run Script</button>
      <button class="btn btn-ghost btn-sm" onclick="scanDisk('${d.device_id}')">ğŸ’¾ Scan Disk</button>
    </div>
    ${d.os_info?`<div style="font-size:12px;color:var(--text3);font-family:var(--mono)">${d.os_info}</div>`:''}
    ${d.disk_details?renderDiskDetails(d.disk_details):''}
  `;
  document.getElementById('panelDeviceOverlay').classList.add('open');
  document.getElementById('panelDevice').classList.add('open');
}

function renderDiskDetails(details) {
  if (!details || !details.length) return '';
  return `<div class="card" style="margin-top:14px">
    <div class="card-label" style="margin-bottom:10px">Disk Usage</div>
    ${details.slice(0,10).map(item => `
      <div class="disk-item">
        <div class="disk-item-name">${item.path||item.name}</div>
        <div class="disk-item-bar"><div class="gauge"><div class="gauge-fill" style="width:${item.pct||0}%;background:#ff9100"></div></div></div>
        <div class="disk-item-size">${item.size||'â€”'}</div>
      </div>`).join('')}
  </div>`;
}

function scanDisk(deviceId) {
  // Send run_task message to agent to do disk scan
  api('/api/dashboard/tasks/', 'POST', {
    name: 'Disk Scan', script_type: 'powershell', trigger_type: 'now',
    target_type: 'device', target_id: deviceId,
    script_body: `
$result = @()
Get-PSDrive -PSProvider FileSystem | ForEach-Object {
  $result += @{path=$_.Root; size=[math]::Round($_.Used/1GB,2); pct=[math]::Round(($_.Used/($_.Used+$_.Free))*100)}
}
# Top folders
Get-ChildItem C:\\ -ErrorAction SilentlyContinue | ForEach-Object {
  $s = (Get-ChildItem $_.FullName -Recurse -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum
  if($s -gt 100MB){ $result += @{path=$_.FullName; size=[math]::Round($s/1GB,2); pct=0} }
}
$result | ConvertTo-Json`,
    description: 'disk_scan_request'
  });
  toast('Disk scan requested', 'info');
}

function quickTask(deviceId) {
  document.getElementById('taskTargetType').value = 'device';
  updateTargetUI();
  document.getElementById('taskTargetId').value = deviceId;
  openModal('modalTask');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TASKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTasks() {
  try {
    allTasks = await api('/api/dashboard/tasks/');
    renderTaskTable();
  } catch(e) {}
}

function filterTasks(el, status) {
  taskStatusFilter = status;
  document.querySelectorAll('#page-tasks .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderTaskTable();
}

function renderTaskTable() {
  let tasks = taskStatusFilter ? allTasks.filter(t => t.status === taskStatusFilter) : allTasks;
  const tbody = document.getElementById('taskTable');
  if (!tasks.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--text3)">No tasks found</td></tr>'; return; }
  tbody.innerHTML = tasks.map(t => `
    <tr>
      <td>
        <div style="font-weight:500">${t.name}</div>
        <div style="font-size:11px;color:var(--text3);font-family:var(--mono)">${t.script_type}</div>
      </td>
      <td>${triggerBadge(t.trigger_type, t.scheduled_at)}</td>
      <td style="font-size:12px;color:var(--text2)">${t.target_type==='device'?t.target_id?.substring(0,8):'All'}</td>
      <td>${taskStatusBadge(t.status, t.cancelled)}</td>
      <td>
        <div style="font-size:12px">
          <span style="color:var(--green)">âœ“${t.success_count}</span>
          <span style="color:var(--red);margin-left:8px">âœ—${t.failed_count}</span>
        </div>
      </td>
      <td style="color:var(--text3);font-size:12px;font-family:var(--mono)">${timeAgo(t.created_at)}</td>
      <td onclick="event.stopPropagation()">
        <div style="display:flex;gap:4px">
          <button class="btn btn-ghost btn-sm" onclick="viewTaskResults('${t.id}','${t.name}')">Results</button>
          ${!t.cancelled&&t.status!=='done'?`<button class="btn btn-ghost btn-sm" onclick="dispatchTask('${t.id}')">â–¶</button>`:''}
          ${!t.cancelled?`<button class="btn btn-danger btn-sm" onclick="cancelTask('${t.id}')">Cancel</button>`:''}
        </div>
      </td>
    </tr>`).join('');
}

function updateTriggerUI() {
  const v = document.getElementById('taskTrigger').value;
  document.getElementById('triggerOnce').style.display     = v==='once'     ? '' : 'none';
  document.getElementById('triggerInterval').style.display = v==='interval' ? '' : 'none';
  document.getElementById('triggerCron').style.display     = v==='cron'     ? '' : 'none';
  document.getElementById('triggerEvent').style.display    = v==='event'    ? '' : 'none';
}

function updateTargetUI() {
  const v = document.getElementById('taskTargetType').value;
  const g = document.getElementById('taskTargetDeviceGroup');
  g.style.display = v === 'device' ? '' : 'none';
  if (v === 'device') {
    const sel = document.getElementById('taskTargetId');
    sel.innerHTML = allDevices.map(d => `<option value="${d.device_id}">${d.label||d.hostname} (${d.status})</option>`).join('');
  }
}

async function createTask() {
  const trigger = document.getElementById('taskTrigger').value;
  let interval_seconds = null;
  if (trigger === 'interval') {
    interval_seconds = parseInt(document.getElementById('taskInterval').value) *
                       parseInt(document.getElementById('taskIntervalUnit').value);
  }
  const data = {
    name:        document.getElementById('taskName').value,
    script_type: document.getElementById('taskScriptType').value,
    script_body: document.getElementById('taskScript').value,
    target_type: document.getElementById('taskTargetType').value,
    target_id:   document.getElementById('taskTargetId')?.value,
    target_platform: document.getElementById('taskPlatform').value,
    trigger_type: trigger,
    scheduled_at: document.getElementById('taskScheduledAt')?.value || null,
    interval_seconds,
    cron_expression: document.getElementById('taskCron')?.value || null,
    event_trigger:   document.getElementById('taskEvent')?.value || null,
  };
  try {
    await api('/api/dashboard/tasks/', 'POST', data);
    closeModal('modalTask');
    toast('Task created', 'success');
    loadTasks();
  } catch(e) { toast('Failed to create task', 'error'); }
}

async function dispatchTask(id) {
  try { await api(`/api/dashboard/tasks/${id}/dispatch`, 'POST'); toast('Task dispatched', 'success'); loadTasks(); }
  catch(e) { toast('Dispatch failed', 'error'); }
}

async function cancelTask(id) {
  try { await api(`/api/dashboard/tasks/${id}/cancel`, 'POST'); toast('Task cancelled', 'info'); loadTasks(); }
  catch(e) { toast('Cancel failed', 'error'); }
}

async function viewTaskResults(taskId, taskName) {
  document.getElementById('panelResultsTitle').textContent = taskName;
  document.getElementById('panelResultsOverlay').classList.add('open');
  document.getElementById('panelResults').classList.add('open');
  document.getElementById('panelResultsBody').innerHTML = '<div style="color:var(--text3);text-align:center;padding:20px">Loading...</div>';
  try {
    const results = await api(`/api/dashboard/tasks/${taskId}/results`);
    if (!results.length) { document.getElementById('panelResultsBody').innerHTML = '<div style="color:var(--text3);text-align:center;padding:20px">No results yet</div>'; return; }
    document.getElementById('panelResultsBody').innerHTML = results.map(r => `
      <div style="margin-bottom:16px;border:1px solid var(--border);border-radius:8px;overflow:hidden">
        <div style="padding:10px 14px;background:var(--bg3);display:flex;justify-content:space-between;align-items:center">
          <span style="font-weight:500">${r.hostname}</span>
          <div style="display:flex;align-items:center;gap:8px">
            ${taskStatusBadge(r.status)}
            <span style="font-size:11px;color:var(--text3);font-family:var(--mono)">${r.exit_code!=null?'exit: '+r.exit_code:''}</span>
          </div>
        </div>
        <div style="padding:10px 14px">
          <div class="progress-bar" style="margin-bottom:8px"><div class="progress-fill ${r.status}" style="width:${r.progress||0}%"></div></div>
          ${r.stdout?`<div class="terminal" style="max-height:200px">${escHtml(r.stdout)}</div>`:''}
          ${r.stderr?`<div style="font-family:var(--mono);font-size:12px;color:var(--red);padding:8px;background:rgba(255,82,82,0.05);border-radius:4px;margin-top:6px">${escHtml(r.stderr)}</div>`:''}
          <div style="font-size:11px;color:var(--text3);margin-top:6px;font-family:var(--mono)">
            ${r.started_at?'Started: '+new Date(r.started_at).toLocaleString():''}
            ${r.completed_at?' Â· Done: '+new Date(r.completed_at).toLocaleString():''}
          </div>
        </div>
      </div>`).join('');
  } catch(e) { document.getElementById('panelResultsBody').innerHTML = '<div style="color:var(--red)">Failed to load results</div>'; }
}

function appendTaskOutput(taskId, deviceId, output, progress) {
  // If results panel is open for this task, append to terminal
  const panel = document.getElementById('panelResults');
  if (panel.classList.contains('open')) {
    const terminals = panel.querySelectorAll('.terminal');
    terminals.forEach(t => { t.textContent += output; t.scrollTop = t.scrollHeight; });
  }
}

function onTaskComplete(msg) {
  toast(`Task ${msg.status} on ${msg.device_id.substring(0,8)}`, msg.status === 'done' ? 'success' : 'error');
  loadTasks();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCRIPT LIBRARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadScripts() {
  try {
    allScripts = await api('/api/scripts/');
    renderScriptGrid();
  } catch(e) {}
}

function filterScripts() { renderScriptGrid(); }

function renderScriptGrid() {
  const cat  = document.getElementById('scriptCatFilter')?.value || '';
  const plat = document.getElementById('scriptPlatFilter')?.value || '';
  let scripts = allScripts.filter(s => {
    if (cat  && s.category !== cat) return false;
    if (plat && s.platform !== plat && s.platform !== 'all') return false;
    return true;
  });
  const grid = document.getElementById('scriptGrid');
  if (!scripts.length) { grid.innerHTML = '<div style="color:var(--text3);font-size:12px;padding:30px;text-align:center;grid-column:1/-1">No scripts found. Click "Load Built-ins" to add starter scripts.</div>'; return; }
  grid.innerHTML = scripts.map(s => `
    <div class="script-card" onclick="runScript('${s.id}')">
      <div class="script-card-name">${s.name}</div>
      <div class="script-card-desc">${s.description||'No description'}</div>
      <div class="script-card-meta">
        <span class="chip ${s.platform}">${s.platform}</span>
        <span class="chip">${s.category}</span>
        <span class="chip" style="font-family:var(--mono)">${s.script_type}</span>
        <span style="font-size:11px;color:var(--text3);margin-left:auto">â–¶ ${s.run_count}</span>
      </div>
    </div>`).join('');
}

function runScript(scriptId) {
  const s = allScripts.find(x => x.id === scriptId);
  if (!s) return;
  document.getElementById('taskName').value       = s.name;
  document.getElementById('taskScriptType').value = s.script_type;
  document.getElementById('taskScript').value     = s.script_body;
  updateTargetUI();
  openModal('modalTask');
}

async function seedScripts() {
  try { await api('/api/scripts/seed', 'POST'); await loadScripts(); toast('Built-in scripts loaded', 'success'); }
  catch(e) { toast('Failed to load scripts', 'error'); }
}

async function saveScript() {
  const data = {
    name: document.getElementById('scriptName').value,
    description: document.getElementById('scriptDesc').value,
    category: document.getElementById('scriptCategory').value,
    platform: document.getElementById('scriptPlatform').value,
    script_type: document.getElementById('scriptType').value,
    script_body: document.getElementById('scriptBody').value,
  };
  try { await api('/api/scripts/', 'POST', data); closeModal('modalScript'); toast('Script saved', 'success'); loadScripts(); }
  catch(e) { toast('Failed to save', 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INVENTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAssets() {
  try {
    allAssets = await api('/api/inventory/');
    renderAssetTable();
  } catch(e) {}
}

function renderAssetTable() {
  const tbody = document.getElementById('assetTable');
  if (!allAssets.length) { tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:30px;color:var(--text3)">No assets yet. Add your first asset or scan a tag.</td></tr>'; return; }
  tbody.innerHTML = allAssets.map(a => `
    <tr onclick="openAsset('${a.id}')">
      <td><span class="asset-tag-badge">${a.asset_tag}</span></td>
      <td style="font-weight:500">${a.name}</td>
      <td style="font-size:12px;color:var(--text2);font-family:var(--mono)">${a.model||'â€”'}</td>
      <td>${a.owner||'â€”'}</td>
      <td style="font-size:12px;color:var(--text2)">${a.location||'â€”'}</td>
      <td style="font-size:12px">${a.category||'â€”'}</td>
      <td>${assetStatusBadge(a.status)}</td>
      <td>${a.device?statusBadge(a.device.status):'<span style="color:var(--text3);font-size:12px">Unlinked</span>'}</td>
      <td onclick="event.stopPropagation()">
        <button class="btn btn-ghost btn-sm" onclick="openAsset('${a.id}')">Edit</button>
      </td>
    </tr>`).join('');
}

async function searchAssets() {
  const q = document.getElementById('assetSearch').value.trim();
  if (!q) { loadAssets(); return; }
  try {
    const result = await api(`/api/inventory/lookup/${encodeURIComponent(q)}`);
    allAssets = Array.isArray(result) ? result : [result];
    renderAssetTable();
  } catch(e) {
    allAssets = [];
    renderAssetTable();
  }
}

async function scanLookup() {
  const q = document.getElementById('scanInput').value.trim();
  if (!q) return;
  const el = document.getElementById('scanResult');
  try {
    const result = await api(`/api/inventory/lookup/${encodeURIComponent(q)}`);
    const a = Array.isArray(result) ? result[0] : result;
    el.innerHTML = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
          <span class="asset-tag-badge">${a.asset_tag}</span>
          ${assetStatusBadge(a.status)}
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px">
          <div><span style="color:var(--text3)">Device: </span>${a.name}</div>
          <div><span style="color:var(--text3)">Model: </span>${a.model||'â€”'}</div>
          <div><span style="color:var(--text3)">Owner: </span>${a.owner||'â€”'}</div>
          <div><span style="color:var(--text3)">Location: </span>${a.location||'â€”'}</div>
        </div>
        ${a.notes?`<div style="margin-top:10px;font-size:12px;color:var(--text3)">${a.notes}</div>`:''}
        ${a.device?`<div style="margin-top:10px">${statusBadge(a.device.status)} <span style="font-size:12px;font-family:var(--mono)">${a.device.hostname||''} ${a.device.ip||''}</span></div>`:''}
      </div>`;
  } catch(e) {
    el.innerHTML = `<div style="color:var(--red);font-size:13px;text-align:center">No asset found matching "${q}"</div>`;
  }
}

function openAsset(id) {
  const a = allAssets.find(x => x.id === id);
  if (!a) return;
  editingAssetId = id;
  document.getElementById('assetModalTitle').textContent = 'Edit Asset';
  document.getElementById('assetTag').value      = a.asset_tag;
  document.getElementById('assetName').value     = a.name;
  document.getElementById('assetModel').value    = a.model||'';
  document.getElementById('assetOwner').value    = a.owner||'';
  document.getElementById('assetLocation').value = a.location||'';
  document.getElementById('assetCategory').value = a.category||'Laptop';
  document.getElementById('assetSerial').value   = a.serial_number||'';
  document.getElementById('assetStatus').value   = a.status||'active';
  document.getElementById('assetFormUrl').value  = a.google_form_url||'';
  document.getElementById('assetNotes').value    = a.notes||'';
  openModal('modalAsset');
}

async function saveAsset() {
  const data = {
    asset_tag:      document.getElementById('assetTag').value,
    name:           document.getElementById('assetName').value,
    model:          document.getElementById('assetModel').value,
    owner:          document.getElementById('assetOwner').value,
    location:       document.getElementById('assetLocation').value,
    category:       document.getElementById('assetCategory').value,
    serial_number:  document.getElementById('assetSerial').value,
    status:         document.getElementById('assetStatus').value,
    google_form_url:document.getElementById('assetFormUrl').value,
    notes:          document.getElementById('assetNotes').value,
  };
  try {
    if (editingAssetId) {
      await api(`/api/inventory/${editingAssetId}`, 'PUT', data);
      toast('Asset updated', 'success');
    } else {
      await api('/api/inventory/', 'POST', data);
      toast('Asset added', 'success');
    }
    closeModal('modalAsset');
    editingAssetId = null;
    loadAssets();
  } catch(e) { toast('Failed to save asset', 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let settingsData = {};

async function loadSettings() {
  try {
    const grouped = await api('/api/settings/');
    settingsData = grouped;
    renderSettings(grouped);
  } catch(e) {}
}

function renderSettings(grouped) {
  const body = document.getElementById('settingsBody');
  const labels = {
    network: 'Network', security: 'Security', auth: 'Authentication',
    updates: 'Agent Updates', alerts: 'Email Alerts', monitoring: 'Monitoring',
  };
  body.innerHTML = Object.entries(grouped).map(([cat, settings]) => `
    <div class="settings-section">
      <div class="settings-section-title">${labels[cat]||cat}</div>
      ${settings.map(s => `
        <div class="setting-row">
          <div class="setting-info">
            <div class="setting-label">${s.label||s.key}</div>
            <div class="setting-desc">${s.key}</div>
          </div>
          <div class="setting-control">
            <input class="form-input" id="setting_${s.key}" value="${s.value||''}"
              type="${s.key.includes('pass')||s.key.includes('token')||s.key.includes('secret')?'password':'text'}"
              placeholder="${s.value==='â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'?'(unchanged)':''}">
          </div>
        </div>`).join('')}
    </div>`).join('');
}

async function saveAllSettings() {
  const updates = {};
  document.querySelectorAll('[id^="setting_"]').forEach(el => {
    const key = el.id.replace('setting_', '');
    if (el.value && el.value !== 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') updates[key] = el.value;
  });
  try {
    await api('/api/settings/', 'PUT', updates);
    toast('Settings saved', 'success');
  } catch(e) { toast('Failed to save settings', 'error'); }
}

async function saveSetting(key, value) {
  try { await api('/api/settings/', 'PUT', {[key]: value}); } catch(e) {}
}

async function toggleSetting(key, el) {
  el.classList.toggle('on');
  const val = el.classList.contains('on') ? 'true' : 'false';
  await saveSetting(key, val);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POLICIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPolicies() {
  try {
    const p = await api('/api/dashboard/policies/default');
    document.getElementById('pol_plugged').value  = p.checkin_plugged_seconds||30;
    document.getElementById('pol_100_80').value   = p.checkin_battery_100_80_seconds||60;
    document.getElementById('pol_79_50').value    = p.checkin_battery_79_50_seconds||180;
    document.getElementById('pol_49_20').value    = p.checkin_battery_49_20_seconds||300;
    document.getElementById('pol_19_10').value    = p.checkin_battery_19_10_seconds||600;
    document.getElementById('pol_9_0').value      = p.checkin_battery_9_0_seconds||900;
    document.getElementById('pol_alert').value    = p.low_battery_alert_threshold||15;
    document.getElementById('pol_disk').value     = p.disk_scan_interval_hours||168;
  } catch(e) {}
}

async function savePolicies() {
  const data = {
    checkin_plugged_seconds:        parseInt(document.getElementById('pol_plugged').value),
    checkin_battery_100_80_seconds: parseInt(document.getElementById('pol_100_80').value),
    checkin_battery_79_50_seconds:  parseInt(document.getElementById('pol_79_50').value),
    checkin_battery_49_20_seconds:  parseInt(document.getElementById('pol_49_20').value),
    checkin_battery_19_10_seconds:  parseInt(document.getElementById('pol_19_10').value),
    checkin_battery_9_0_seconds:    parseInt(document.getElementById('pol_9_0').value),
    low_battery_alert_threshold:    parseInt(document.getElementById('pol_alert').value),
    disk_scan_interval_hours:       parseInt(document.getElementById('pol_disk').value),
  };
  try { await api('/api/dashboard/policies/default', 'PUT', data); toast('Policies saved', 'success'); }
  catch(e) { toast('Failed to save', 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEPLOY / BUILD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDeploySettings() {
  try {
    const raw = await api('/api/settings/raw');
    if (raw.server_local_ip) document.getElementById('buildLocalIP').value = raw.server_local_ip;
    if (raw.server_vpn_ip)   document.getElementById('buildVpnIP').value   = raw.server_vpn_ip;
    if (raw.server_port)     document.getElementById('buildPort').value     = raw.server_port;
    if (raw.agent_version_win) document.getElementById('verWin').value = raw.agent_version_win;
    if (raw.agent_version_lnx) document.getElementById('verLnx').value = raw.agent_version_lnx;
    if (raw.agent_version_adr) document.getElementById('verAdr').value = raw.agent_version_adr;
    if (raw.auto_update_win === 'true') document.getElementById('toggleAutoWin').classList.add('on');
    if (raw.auto_update_lnx === 'true') document.getElementById('toggleAutoLnx').classList.add('on');
    if (raw.auto_update_adr === 'true') document.getElementById('toggleAutoAdr').classList.add('on');
  } catch(e) {}
}

async function buildAgent(platform) {
  const statusId = {windows:'winStatus', linux:'linuxStatus', android:'androidStatus'}[platform];
  const btnId    = {windows:'btnWin',    linux:'btnLnx',     android:'btnAdr'}[platform];
  const statusEl = document.getElementById(statusId);
  const btnEl    = document.getElementById(btnId);
  statusEl.style.display = 'block';
  statusEl.style.color   = 'var(--text3)';
  statusEl.innerHTML     = '<span style="opacity:.7">â³ Building â€” this can take 30-60s...</span>';
  btnEl.disabled = true;

  try {
    // Must use raw fetch â€” the response is a binary file, not JSON
    const res = await fetch('/api/builds/build/' + platform, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
      body: JSON.stringify({
        local_ip: document.getElementById('buildLocalIP').value,
        vpn_ip:   document.getElementById('buildVpnIP').value,
        port:     document.getElementById('buildPort').value,
      })
    });

    if (!res.ok) {
      // Error responses ARE json
      const err = await res.json().catch(() => ({ detail: res.statusText }));
      throw new Error(JSON.stringify(err));
    }

    // Trigger download from the binary blob
    const blob = await res.blob();
    const cd = res.headers.get('content-disposition') || '';
    const match = cd.match(/filename[^;=\n]*=(['"\w\-\.]+)/);
    const filename = match ? match[1].replace(/['"]/g,'') : `sovereign-agent-${platform}.${platform==='windows'?'msi':platform==='linux'?'sh':'zip'}`;

    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);

    statusEl.style.color = '#69ff47';
    statusEl.innerHTML   = `âœ“ <strong>${filename}</strong> downloaded successfully`;
  } catch(e) {
    statusEl.style.color = '#ff5252';
    statusEl.textContent = 'âœ— Build failed: ' + e.message;
  }
  btnEl.disabled = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadLogs() {
  try {
    const logs = await api('/api/dashboard/logs');
    const tbody = document.getElementById('logsTable');
    tbody.innerHTML = logs.map(l => `
      <tr>
        <td style="font-size:12px;font-family:var(--mono);color:var(--text3);white-space:nowrap">${new Date(l.timestamp).toLocaleString()}</td>
        <td style="font-size:12px">${l.hostname||'â€”'}</td>
        <td><span class="badge badge-${l.level==='error'?'offline':l.level==='warning'?'warning':'info'}" style="font-size:11px">${l.level}</span></td>
        <td style="font-size:12px;color:var(--text2)">${l.message}</td>
      </tr>`).join('');
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL / PANEL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) {
  document.getElementById(id).classList.add('open');
  if (id === 'modalTask') { updateTriggerUI(); updateTargetUI(); }
  if (id === 'modalAsset' && !editingAssetId) {
    ['assetTag','assetName','assetModel','assetOwner','assetLocation','assetSerial','assetFormUrl','assetNotes'].forEach(f => document.getElementById(f).value='');
    document.getElementById('assetCategory').value = 'Laptop';
    document.getElementById('assetStatus').value   = 'active';
    document.getElementById('assetModalTitle').textContent = 'Add Asset';
  }
  if (id === 'modalScan') {
    document.getElementById('scanInput').value = '';
    document.getElementById('scanResult').innerHTML = '';
    setTimeout(() => document.getElementById('scanInput').focus(), 100);
  }
}

function closeModal(id) { document.getElementById(id).classList.remove('open'); editingAssetId=null; }
function closePanel(id, target) {
  if (target && target.id !== id+'Overlay') return;
  document.getElementById(id).classList.remove('open');
  document.getElementById(id+'Overlay').classList.remove('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type='info') {
  const c = document.getElementById('toastContainer');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  c.appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function statusBadge(status) {
  return `<span class="badge badge-${status==='online'?'online':'offline'}"><span class="badge-dot"></span>${status}</span>`;
}
function assetStatusBadge(status) {
  const map = {active:'info',retired:'offline',lost:'warning',stolen:'offline'};
  return `<span class="badge badge-${map[status]||'info'}">${status}</span>`;
}
function platformChip(p) {
  const map = {windows:'ğŸªŸ Win',linux:'ğŸ§ Linux',android:'ğŸ¤– Android'};
  return `<span class="chip ${p}">${map[p]||p}</span>`;
}
function taskStatusBadge(status, cancelled) {
  if (cancelled) return `<span class="task-status status-cancelled">Cancelled</span>`;
  const map = {pending:'â³ pending',dispatched:'â³ dispatched',running:'âŸ³ running',done:'âœ“ done',failed:'âœ— failed',cancelled:'â€” cancelled'};
  const cls = {pending:'',dispatched:'',running:'status-running',done:'status-done',failed:'status-failed',cancelled:'status-cancelled'};
  return `<span class="task-status ${cls[status]||''}">${map[status]||status}</span>`;
}
function triggerBadge(type, scheduledAt) {
  const map = {now:'â–¶ Now',once:'ğŸ• Once',interval:'â†» Interval',cron:'â± Cron',event:'âš¡ Event'};
  const badge = map[type]||type;
  const sub = scheduledAt ? `<div style="font-size:11px;color:var(--text3);font-family:var(--mono)">${new Date(scheduledAt).toLocaleString()}</div>` : '';
  return `<div><span class="badge badge-info" style="font-size:11px">${badge}</span>${sub}</div>`;
}
function gauge(val) {
  if (val == null) return '<span style="color:var(--text3)">â€”</span>';
  const c = val > 90 ? 'var(--red)' : val > 70 ? 'var(--yellow)' : 'var(--accent)';
  return `<div style="display:flex;flex-direction:column;gap:3px">
    <div style="font-size:11px;font-family:var(--mono)">${val.toFixed(0)}%</div>
    <div class="gauge" style="width:60px"><div class="gauge-fill" style="width:${val}%;background:${c}"></div></div>
  </div>`;
}
function miniGauge(val, color='#00e5ff') {
  if (val == null) return 'â€”';
  return `<div style="display:flex;flex-direction:column;gap:2px">
    <div style="font-size:11px;font-family:var(--mono)">${val.toFixed(0)}%</div>
    <div class="gauge"><div class="gauge-fill" style="width:${val}%;background:${color}"></div></div>
  </div>`;
}
function metricRow(label, val, color) {
  const pct = val != null ? val.toFixed(0) : 'â€”';
  return `<div class="gauge-row">
    <div class="gauge-label"><span>${label}</span><span>${pct}%</span></div>
    <div class="gauge"><div class="gauge-fill" style="width:${val||0}%;background:${color}"></div></div>
  </div>`;
}
function batteryDisplay(level, charging) {
  if (level == null) return '<span style="color:var(--text3)">â€”</span>';
  const c = level < 15 ? 'var(--red)' : level < 30 ? 'var(--yellow)' : 'var(--green)';
  return `<span style="font-size:12px;font-family:var(--mono);color:${c}">${charging?'âš¡':'ğŸ”‹'} ${level.toFixed(0)}%</span>`;
}
function timeAgo(ts) {
  if (!ts) return 'â€”';
  const diff = (Date.now() - new Date(ts).getTime()) / 1000;
  if (diff < 60)   return `${diff.toFixed(0)}s ago`;
  if (diff < 3600) return `${(diff/60).toFixed(0)}m ago`;
  if (diff < 86400)return `${(diff/3600).toFixed(0)}h ago`;
  return `${(diff/86400).toFixed(0)}d ago`;
}
function escHtml(str) { return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCKDOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lockdownActive = false;

async function loadLockdown() {
  try {
    const s = await api('/api/lockdown/status');
    lockdownActive = s.active;
    const banner = document.getElementById('lockdownBanner');
    if (banner) banner.style.display = s.active ? 'block' : 'none';
    const txt = document.getElementById('lockdownStatusText');
    const area = document.getElementById('lockdownToggleArea');
    if (!txt) return;
    if (s.active) {
      txt.innerHTML = '<span style="color:var(--red)">ğŸ”’ ACTIVE â€” Logins Blocked</span>';
      document.getElementById('lockdownStatusCard').style.borderColor = 'var(--red)';
      area.innerHTML = `
        <div style="text-align:right">
          <div class="form-group" style="margin-bottom:8px">
            <input class="form-input" id="lockdownReason" placeholder="Reason for disabling..." style="width:260px">
          </div>
          <button class="btn btn-primary" onclick="disableLockdown()" style="background:var(--green)">ğŸ”“ Disable Lockdown</button>
        </div>`;
    } else {
      txt.innerHTML = '<span style="color:var(--green)">âœ“ Normal â€” Logins Allowed</span>';
      document.getElementById('lockdownStatusCard').style.borderColor = 'var(--border)';
      area.innerHTML = `
        <div style="text-align:right">
          <div class="form-group" style="margin-bottom:8px">
            <input class="form-input" id="lockdownReason" placeholder="Reason (optional)..." style="width:260px">
          </div>
          <button class="btn btn-danger" onclick="enableLockdown()">ğŸ”’ Enable Lockdown</button>
        </div>`;
    }
    await loadLockdownHistory();
  } catch(e) {}
}

async function enableLockdown() {
  const reason = document.getElementById('lockdownReason')?.value || '';
  if (!confirm('Enable lockdown? All users will be blocked from logging in.')) return;
  try {
    await api('/api/lockdown/enable', 'POST', {reason});
    toast('Lockdown ENABLED â€” logins blocked', 'error');
    loadLockdown();
  } catch(e) { toast('Failed: ' + e.message, 'error'); }
}

async function disableLockdown() {
  const reason = document.getElementById('lockdownReason')?.value || '';
  try {
    await api('/api/lockdown/disable', 'POST', {reason});
    toast('Lockdown disabled â€” logins restored', 'success');
    loadLockdown();
  } catch(e) { toast('Failed: ' + e.message, 'error'); }
}

async function loadLockdownHistory() {
  try {
    const history = await api('/api/lockdown/history');
    const tbody = document.getElementById('lockdownHistoryTable');
    if (!tbody) return;
    if (!history.length) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--text3)">No lockdown events yet</td></tr>'; return; }
    tbody.innerHTML = history.map(e => `
      <tr>
        <td style="font-family:var(--mono);font-size:12px;color:var(--text3)">${new Date(e.timestamp).toLocaleString()}</td>
        <td><span class="badge badge-${e.action==='enabled'?'offline':'online'}">${e.action}</span></td>
        <td style="font-size:12px">${e.reason||'â€”'}</td>
        <td style="font-size:12px;color:var(--text2)">${e.triggered_by}</td>
      </tr>`).join('');
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAKE ON LAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadWol() {
  try {
    // Devices table
    const devices = allDevices;
    const tbody = document.getElementById('wolDeviceTable');
    if (!tbody) return;
    tbody.innerHTML = devices.map(d => `
      <tr>
        <td style="font-weight:500">${d.label||d.hostname}</td>
        <td>${platformChip(d.platform)}</td>
        <td>
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-family:var(--mono);font-size:12px">${d.mac_address||'â€”'}</span>
            ${!d.mac_address?`<input class="form-input" style="width:140px" id="mac_${d.device_id}" placeholder="AA:BB:CC:DD:EE:FF" onchange="setMac('${d.device_id}')">`:
            `<button class="btn btn-ghost btn-sm" onclick="clearMac('${d.device_id}')">Edit</button>`}
          </div>
        </td>
        <td>${statusBadge(d.status)}</td>
        <td>
          ${d.mac_address?`<button class="btn btn-primary btn-sm" onclick="wakeDevice('${d.device_id}')">âš¡ Wake</button>`:
          `<span style="font-size:11px;color:var(--text3)">No MAC</span>`}
        </td>
      </tr>`).join('') || '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text3)">No devices enrolled</td></tr>';

    // History
    const history = await api('/api/wol/history');
    const histTbody = document.getElementById('wolHistoryTable');
    if (!histTbody) return;
    histTbody.innerHTML = history.length ? history.map(e => `
      <tr>
        <td style="font-family:var(--mono);font-size:12px;color:var(--text3)">${new Date(e.timestamp).toLocaleString()}</td>
        <td>${e.target}</td>
        <td style="font-family:var(--mono);font-size:12px">${e.mac}</td>
        <td style="font-size:12px">${e.triggered_by}</td>
      </tr>`).join('') : '<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--text3)">No WoL events yet</td></tr>';
  } catch(e) {}
}

async function wakeDevice(deviceId) {
  try {
    const r = await api(`/api/wol/wake/${deviceId}`, 'POST', {});
    toast(`Magic packet sent to ${r.mac}`, 'success');
    loadWol();
  } catch(e) { toast('WoL failed: ' + e.message, 'error'); }
}

async function setMac(deviceId) {
  const mac = document.getElementById(`mac_${deviceId}`)?.value;
  if (!mac) return;
  try {
    await api(`/api/wol/device/${deviceId}/mac`, 'PUT', {mac});
    toast('MAC address saved', 'success');
    await loadDevices();
    loadWol();
  } catch(e) { toast('Failed', 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ASSET TAG GENERATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tagLogoDataUrl = null;
let generatedTags = [];

function handleLogoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    tagLogoDataUrl = e.target.result;
    toast('Logo uploaded', 'success');
    refreshTagPreview();
  };
  reader.readAsDataURL(file);
}

function getTagTemplate() {
  return {
    owner:  document.getElementById('tplOwner')?.value || 'Property of:',
    reward: document.getElementById('tplReward')?.value || 'Reward may be issued if found',
    found:  document.getElementById('tplFound')?.value || 'scan if found: report device here or go to',
    qrUrl:  document.getElementById('tplQrUrl')?.value || '',
    bg:     document.getElementById('tplBg')?.value || '#000000',
    fg:     document.getElementById('tplFg')?.value || '#ffffff',
  };
}

function buildTagData(assetTag, deviceName, model) {
  const tpl = getTagTemplate();
  return {
    ...tpl,
    assetTag,
    deviceName: deviceName || '',   // FIXED: don't fall back to assetTag as device name
    model: model || '',
  };
}

function renderTagHTML(tag, mini=false) {
  // FIXED layout: proper sizing, no overlapping, clear hierarchy
  const W = mini ? 320 : 420;
  const H = mini ? 120 : 158;
  const qrSize = mini ? 80 : 108;
  const pad = mini ? 6 : 10;
  const fLg = mini ? 11 : 15;  // asset tag number â€” largest
  const fMd = mini ? 9  : 11;  // device name / model
  const fSm = mini ? 7  : 9;   // labels & footer text

  const ownerBlock = tagLogoDataUrl
    ? `<img src="${tagLogoDataUrl}" style="height:${mini?14:18}px;margin-bottom:${mini?2:4}px;object-fit:contain;display:block">`
    : `<div style="font-size:${fSm}px;font-weight:700;letter-spacing:.06em;border:1px solid ${tag.fg};padding:1px 5px;display:inline-block;margin-bottom:${mini?2:4}px">${escHtml(tag.owner)}</div>`;

  return `<div class="asset-tag-preview" data-tag="${escHtml(tag.assetTag)}" data-url="${escHtml(tag.qrUrl)}"
    style="width:${W}px;height:${H}px;background:${tag.bg};color:${tag.fg};display:flex;
           border-radius:5px;overflow:hidden;font-family:'Courier New',monospace;
           box-shadow:0 2px 8px rgba(0,0,0,.5);cursor:pointer;box-sizing:border-box"
    onclick="selectTagPreview(this)">

    <!-- LEFT: QR CODE -->
    <div style="width:${qrSize + pad*2}px;flex-shrink:0;display:flex;align-items:center;
                justify-content:center;padding:${pad}px;
                border-right:1px solid rgba(255,255,255,0.15)">
      <canvas class="qr-canvas" width="${qrSize}" height="${qrSize}"
              data-url="${escHtml(tag.qrUrl)}"
              style="display:block;image-rendering:pixelated"></canvas>
    </div>

    <!-- RIGHT: INFO -->
    <div style="flex:1;padding:${pad}px ${pad}px ${pad+14}px ${pad}px;
                display:flex;flex-direction:column;gap:${mini?2:3}px;
                overflow:hidden;position:relative">

      <!-- Owner / Logo -->
      ${ownerBlock}

      <!-- Asset Tag Number â€” prominent -->
      <div style="font-size:${fLg}px;font-weight:700;letter-spacing:.05em;
                  line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
        <span style="opacity:0.55;font-size:${fSm}px;font-weight:400">ASSET# </span>${escHtml(tag.assetTag)}
      </div>

      <!-- Device name (only shown if set) -->
      ${tag.deviceName ? `<div style="font-size:${fMd}px;opacity:0.85;white-space:nowrap;
                              overflow:hidden;text-overflow:ellipsis;line-height:1.2">
        <span style="opacity:0.55">device: </span>${escHtml(tag.deviceName)}
      </div>` : ''}

      <!-- Model (only shown if set) -->
      ${tag.model ? `<div style="font-size:${fSm}px;opacity:0.65;white-space:nowrap;
                         overflow:hidden;text-overflow:ellipsis">
        <span style="opacity:0.8">model: </span>${escHtml(tag.model)}
      </div>` : ''}

      <!-- Reward text -->
      <div style="font-size:${fSm}px;opacity:0.6;margin-top:auto;line-height:1.3">
        ${escHtml(tag.reward)}
      </div>

      <!-- BOTTOM FOOTER BAR â€” absolutely positioned, no overlap -->
      <div style="position:absolute;bottom:0;left:0;right:0;
                  padding:2px ${pad}px;
                  font-size:${fSm - 1}px;opacity:0.55;
                  border-top:1px solid rgba(255,255,255,0.12);
                  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
                  background:rgba(0,0,0,0.2)">
        ${escHtml(tag.found)} ${escHtml(tag.qrUrl)}
      </div>
    </div>
  </div>`;
}

function generateTagBatch() {
  const year  = document.getElementById('tagYear')?.value || '2026';
  const start = parseInt(document.getElementById('tagStart')?.value || '1');
  const end   = parseInt(document.getElementById('tagEnd')?.value || '5');
  const custom = (document.getElementById('tagCustomList')?.value || '').split('\n').map(s=>s.trim()).filter(Boolean);
  generatedTags = [];

  if (custom.length) {
    // Custom list: each line IS the asset tag number â€” look up name from inventory
    custom.forEach(line => {
      const tagId = line.trim();
      generatedTags.push(buildTagData(tagId, '', ''));
    });
  } else {
    // Range mode: generate 2026-001, 2026-002, etc.
    const clampedEnd = Math.min(end, start + 199); // max 200 at once
    for (let i = start; i <= clampedEnd; i++) {
      const tagId = `${year}-${String(i).padStart(3, '0')}`;
      generatedTags.push(buildTagData(tagId, '', ''));
    }
  }

  // Auto-fill device name / model from inventory if asset exists
  generatedTags = generatedTags.map(t => {
    const asset = allAssets.find(a => a.asset_tag === t.assetTag);
    if (asset) {
      t.deviceName = asset.name || '';
      t.model      = asset.model || '';
      if (asset.google_form_url) t.qrUrl = asset.google_form_url;
      if (asset.owner) t.owner = `Property of:${asset.owner}`;
    }
    return t;
  });

  refreshTagPreview();
  if (typeof showToast === 'function') showToast(`Generated ${generatedTags.length} tag${generatedTags.length>1?'s':''}`, 'success');
}

function refreshTagPreview() {
  if (!generatedTags.length) {
    const year = document.getElementById('tagYear')?.value || '2026';
    // Preview shows the tag number correctly, device name blank (not the tag ID)
    generatedTags = [buildTagData(`${year}-001`, '', '')];
  }
  const tpl = getTagTemplate();
  // Merge template (colors, text) but preserve tag-specific fields
  generatedTags = generatedTags.map(t => ({
    ...tpl,
    assetTag:   t.assetTag,
    deviceName: t.deviceName,
    model:      t.model,
  }));
  const grid = document.getElementById('tagPreviewGrid');
  if (!grid) return;
  grid.innerHTML = generatedTags.map(t => `
    <div style="display:flex;flex-direction:column;align-items:flex-start;gap:4px">
      ${renderTagHTML(t)}
      <div style="font-size:10px;color:var(--text3);font-family:monospace;padding-left:2px">
        ${escHtml(t.assetTag)}${t.deviceName ? ' â€” ' + escHtml(t.deviceName) : ''}
      </div>
    </div>`).join('');
  const countEl = document.getElementById('tagPreviewCount');
  if (countEl) countEl.textContent = `${generatedTags.length} tag${generatedTags.length>1?'s':''}`;
  setTimeout(renderQRCodes, 80);
}

function renderQRCodes() {
  document.querySelectorAll('.qr-canvas').forEach(canvas => {
    const url = canvas.dataset.url;
    if (!url) return;
    drawQR(canvas, url);
  });
}

// Minimal QR code renderer using data matrix approach
function drawQR(canvas, text) {
  // Use qrcode.js if available, else draw placeholder
  const ctx = canvas.getContext('2d');
  const size = canvas.width;
  // Draw a placeholder that looks like a QR code
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,size,size);
  ctx.fillStyle = '#000000';
  // Finder patterns
  [[0,0],[size-21,0],[0,size-21]].forEach(([x,y]) => {
    ctx.fillRect(x,y,21,21);
    ctx.fillStyle='#fff';
    ctx.fillRect(x+3,y+3,15,15);
    ctx.fillStyle='#000';
    ctx.fillRect(x+6,y+6,9,9);
  });
  // Pseudo-random data based on text hash
  let hash = 0;
  for(let i=0;i<text.length;i++) hash=(hash<<5)-hash+text.charCodeAt(i)|0;
  const cellSize = Math.max(1, Math.floor(size/25));
  for(let r=0;r<25;r++) {
    for(let c=0;c<25;c++) {
      if((hash^(r*37+c*13))&1) {
        ctx.fillRect(c*cellSize,r*cellSize,cellSize,cellSize);
      }
    }
  }
  hash = (hash*1664525+1013904223)|0;
}

async function printTags() {
  if (!generatedTags.length) { toast('Generate tags first', 'error'); return; }
  const tpl = getTagTemplate();
  const printWin = window.open('','_blank','width=800,height=600');
  const tagsHtml = generatedTags.map(t => `
    <div style="display:inline-block;margin:8px;width:380px;height:160px;background:${t.bg};color:${t.fg};
      font-family:monospace;border-radius:6px;overflow:hidden;position:relative;page-break-inside:avoid">
      <div style="display:flex;height:100%">
        <div style="width:108px;display:flex;align-items:center;justify-content:center;padding:8px;flex-shrink:0">
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=90x90&data=${encodeURIComponent(t.qrUrl||'https://sovereignrmm.local')}&bgcolor=${t.bg.replace('#','')}&color=${t.fg.replace('#','')}" width="90" height="90">
        </div>
        <div style="flex:1;padding:8px 8px 8px 0;display:flex;flex-direction:column;justify-content:space-between;overflow:hidden">
          <div>
            ${tagLogoDataUrl?`<img src="${tagLogoDataUrl}" style="height:20px;margin-bottom:4px;object-fit:contain">`:
            `<div style="font-size:11px;font-weight:700;border:1px solid ${t.fg};padding:1px 6px;display:inline-block;margin-bottom:4px">${t.owner}</div>`}
            <div style="font-size:12px;margin-bottom:2px"><span style="opacity:0.7">device: </span><strong>${t.deviceName}</strong></div>
            <div style="font-size:12px;margin-bottom:2px"><span style="opacity:0.7">asset-tag: </span><strong>${t.assetTag}</strong></div>
            <div style="font-size:11px;opacity:0.8"><span style="opacity:0.7">model: </span>${t.model}</div>
          </div>
          <div style="font-size:9px;opacity:0.8">${t.reward}</div>
        </div>
      </div>
      <div style="position:absolute;bottom:0;left:0;right:0;font-size:9px;opacity:0.7;text-align:center;padding:3px;border-top:1px solid rgba(255,255,255,0.2)">
        ${t.found} ${t.qrUrl}
      </div>
    </div>`).join('');
  printWin.document.write(`<!DOCTYPE html><html><head><title>Asset Tags</title>
    <style>body{margin:0;padding:16px;background:#f0f0f0} @media print{body{background:none}}</style>
    </head><body>
    <div style="margin-bottom:12px;font-family:sans-serif;font-size:13px;color:#666">
      ${generatedTags.length} Asset Tags â€” Print this page or Save as PDF
      <button onclick="window.print()" style="margin-left:12px;padding:6px 14px;background:#000;color:#fff;border:none;border-radius:4px;cursor:pointer">ğŸ–¨ Print</button>
    </div>
    ${tagsHtml}
    
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• GROUPS â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-groups">
  <div class="topbar">
    <div><div class="topbar-title">Device Groups</div><div class="topbar-sub">Organize devices into named groups for bulk targeting</div></div>
    <div class="topbar-actions">
      <button class="btn btn-primary btn-sm" onclick="openModal('modalCreateGroup')">+ New Group</button>
    </div>
  </div>
  <div class="page-body">
    <div id="groupsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px">
      <div style="color:var(--text3);text-align:center;padding:40px;grid-column:1/-1">Loading...</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SOFTWARE â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-software">
  <div class="topbar">
    <div><div class="topbar-title">Software Inventory</div><div class="topbar-sub">Installed applications across all devices</div></div>
    <div class="topbar-actions">
      <select class="form-input" id="softwareDeviceFilter" style="width:200px" onchange="loadSoftware()">
        <option value="">All Devices</option>
      </select>
      <input class="form-input" id="softwareSearch" placeholder="Search apps..." style="width:200px" oninput="filterSoftwareTable()">
    </div>
  </div>
  <div class="page-body">
    <div class="table-wrap">
      <table>
        <thead><tr><th>Application</th><th>Version</th><th>Publisher</th><th>Install Date</th><th>Device</th><th>Actions</th></tr></thead>
        <tbody id="softwareTable"><tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text3)">Select a device or scan to see software</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• ALERT RULES â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-alert-rules">
  <div class="topbar">
    <div><div class="topbar-title">Alert Rules</div><div class="topbar-sub">Trigger email alerts when metrics cross thresholds</div></div>
    <div class="topbar-actions">
      <button class="btn btn-primary btn-sm" onclick="openModal('modalCreateAlertRule')">+ New Rule</button>
    </div>
  </div>
  <div class="page-body">
    <div id="alertRulesContainer">
      <div style="color:var(--text3);text-align:center;padding:40px">Loading...</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• REPORTS â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-reports">
  <div class="topbar">
    <div><div class="topbar-title">Reports</div><div class="topbar-sub">Weekly device health summaries via email</div></div>
    <div class="topbar-actions">
      <button class="btn btn-ghost btn-sm" onclick="previewReport()">ğŸ‘ Preview</button>
      <button class="btn btn-primary btn-sm" onclick="sendReportNow()">ğŸ“§ Send Now</button>
    </div>
  </div>
  <div class="page-body">
    <div style="display:grid;grid-template-columns:300px 1fr;gap:20px">
      <div>
        <div class="card">
          <div class="card-label" style="margin-bottom:14px">Schedule</div>
          <div class="form-group">
            <label class="form-label">Send report</label>
            <select class="form-input" id="reportSchedule">
              <option value="weekly">Weekly (Monday 8am UTC)</option>
              <option value="off">Off</option>
            </select>
          </div>
          <button class="btn btn-primary" style="width:100%" onclick="saveReportSettings()">Save</button>
        </div>
        <div class="card" style="margin-top:16px">
          <div class="card-label" style="margin-bottom:8px">About Reports</div>
          <div style="font-size:12px;color:var(--text3);line-height:1.7">Reports are sent to the Alert Email configured in Email Alerts. They include device counts, online/offline status, CPU/RAM/disk for each device, and task success/failure counts over the past 7 days.</div>
        </div>
      </div>
      <div>
        <div class="section-header"><div class="section-title">Report Preview</div></div>
        <iframe id="reportPreviewFrame" style="width:100%;height:600px;border:1px solid var(--border);border-radius:6px;background:#fff"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• PROCESS MANAGER MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal" id="modalProcessManager">
  <div class="modal-box" style="max-width:700px;width:95%">
    <div class="modal-header">
      <div class="modal-title">Process Manager â€” <span id="processDeviceName"></span></div>
      <button class="modal-close" onclick="closeModal('modalProcessManager')">âœ•</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
      <input class="form-input" id="processSearch" placeholder="Filter processes..." style="flex:1" oninput="filterProcesses()">
      <button class="btn btn-ghost btn-sm" onclick="refreshProcesses()">â†» Refresh</button>
    </div>
    <div class="table-wrap" style="max-height:420px;overflow-y:auto">
      <table>
        <thead><tr><th>PID</th><th>Name</th><th>CPU %</th><th>RAM (MB)</th><th>Actions</th></tr></thead>
        <tbody id="processTable"><tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text3)">Click Refresh to load processes</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• CREATE GROUP MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal" id="modalCreateGroup">
  <div class="modal-box" style="max-width:420px">
    <div class="modal-header">
      <div class="modal-title">New Device Group</div>
      <button class="modal-close" onclick="closeModal('modalCreateGroup')">âœ•</button>
    </div>
    <div class="form-group"><label class="form-label">Group Name</label><input class="form-input" id="newGroupName" placeholder="e.g. Laptops, Servers, Lab A"></div>
    <div class="form-group"><label class="form-label">Description</label><input class="form-input" id="newGroupDesc" placeholder="Optional description"></div>
    <div class="form-group"><label class="form-label">Color</label><input class="form-input" id="newGroupColor" type="color" value="#00e5ff"></div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-primary" style="flex:1" onclick="createGroup()">Create Group</button>
      <button class="btn btn-ghost" onclick="closeModal('modalCreateGroup')">Cancel</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• CREATE ALERT RULE MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal" id="modalCreateAlertRule">
  <div class="modal-box" style="max-width:460px">
    <div class="modal-header">
      <div class="modal-title">New Alert Rule</div>
      <button class="modal-close" onclick="closeModal('modalCreateAlertRule')">âœ•</button>
    </div>
    <div class="form-group"><label class="form-label">Rule Name</label><input class="form-input" id="ruleNameInput" placeholder="e.g. High CPU Warning"></div>
    <div class="form-grid form-grid-2">
      <div class="form-group"><label class="form-label">Metric</label>
        <select class="form-input" id="ruleMetricInput">
          <option value="cpu">CPU %</option><option value="ram">RAM %</option>
          <option value="disk">Disk %</option><option value="battery">Battery %</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Condition</label>
        <select class="form-input" id="ruleOperatorInput">
          <option value="gt">Greater than (&gt;)</option>
          <option value="lt">Less than (&lt;)</option>
        </select>
      </div>
    </div>
    <div class="form-grid form-grid-2">
      <div class="form-group"><label class="form-label">Threshold (%)</label><input class="form-input" id="ruleThresholdInput" type="number" value="90" min="1" max="100"></div>
      <div class="form-group"><label class="form-label">For at least (min)</label><input class="form-input" id="ruleDurationInput" type="number" value="5" min="1"></div>
    </div>
    <div class="form-group"><label class="form-label">Target</label>
      <select class="form-input" id="ruleTargetInput" onchange="toggleRuleDeviceSelect(this.value)">
        <option value="all">All Devices</option>
        <option value="device">Specific Device</option>
      </select>
    </div>
    <div class="form-group" id="ruleDeviceSelectGroup" style="display:none">
      <label class="form-label">Device</label>
      <select class="form-input" id="ruleDeviceInput"></select>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-primary" style="flex:1" onclick="createAlertRule()">Create Rule</button>
      <button class="btn btn-ghost" onclick="closeModal('modalCreateAlertRule')">Cancel</button>
    </div>
  </div>
</div>

</body></html>`);
  printWin.document.close();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMAIL SERVICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadEmailSettings() {
  try {
    const raw = await api('/api/settings/raw');
    if (document.getElementById('smtpHost')) {
      document.getElementById('smtpHost').value = raw.smtp_host || '';
      document.getElementById('smtpPort').value = raw.smtp_port || '587';
      document.getElementById('smtpUser').value = raw.smtp_user || '';
      document.getElementById('alertEmail').value = raw.alert_email || '';
    }
    await loadEmailTemplates();
  } catch(e) {}
}

async function saveEmailSettings() {
  const data = {
    smtp_host:   document.getElementById('smtpHost').value,
    smtp_port:   document.getElementById('smtpPort').value,
    smtp_user:   document.getElementById('smtpUser').value,
    smtp_pass:   document.getElementById('smtpPass').value,
    alert_email: document.getElementById('alertEmail').value,
  };
  try {
    await api('/api/settings/', 'PUT', data);
    toast('Email settings saved', 'success');
  } catch(e) { toast('Failed to save', 'error'); }
}

async function testEmail() {
  try {
    const r = await api('/api/email/test', 'POST', {});
    toast(`Test email sent to ${r.to}`, 'success');
  } catch(e) { toast('Email test failed: ' + e.message, 'error'); }
}

async function seedEmailTemplates() {
  try {
    await api('/api/email/templates/seed', 'POST', {});
    toast('Templates loaded', 'success');
    loadEmailTemplates();
  } catch(e) {}
}

async function loadEmailTemplates() {
  try {
    const templates = await api('/api/email/templates');
    const el = document.getElementById('emailTemplates');
    if (!el) return;
    if (!templates.length) { el.innerHTML = '<div style="color:var(--text3);text-align:center;padding:20px">No templates yet. Click "Load Templates" above.</div>'; return; }
    el.innerHTML = templates.map(t => `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
          <div>
            <div style="font-weight:600">${t.name}</div>
            <div style="font-size:11px;color:var(--text3);font-family:var(--mono);margin-top:2px">trigger: ${t.trigger}</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div class="toggle ${t.active?'on':''}" onclick="toggleTemplate('${t.id}',${!t.active},this)"></div>
            <span style="font-size:11px;color:var(--text3)">${t.active?'Active':'Inactive'}</span>
          </div>
        </div>
        <div class="form-group"><label class="form-label">Subject</label>
          <input class="form-input" id="tplSubject_${t.id}" value="${escHtml(t.subject)}">
        </div>
        <div class="form-group"><label class="form-label">Body (HTML)</label>
          <textarea class="form-textarea" id="tplBody_${t.id}" rows="4">${escHtml(t.body_html)}</textarea>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="saveTemplate('${t.id}')">Save</button>
      </div>`).join('');
  } catch(e) {}
}

async function toggleTemplate(id, active, el) {
  el.classList.toggle('on');
  try { await api(`/api/email/templates/${id}`, 'PUT', {active}); } catch(e) {}
}

async function saveTemplate(id) {
  const subject = document.getElementById(`tplSubject_${id}`)?.value;
  const body_html = document.getElementById(`tplBody_${id}`)?.value;
  try {
    await api(`/api/email/templates/${id}`, 'PUT', {subject, body_html});
    toast('Template saved', 'success');
  } catch(e) { toast('Failed', 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKUP / RESTORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportBackup() {
  const a = document.createElement('a');
  a.href = '/api/backup/export';
  a.download = `sovereign_rmm_backup_${new Date().toISOString().slice(0,10)}.zip`;
  a.click();
}

async function importBackup(event) {
  const file = event.target.files[0];
  if (!file) return;
  const status = document.getElementById('importStatus');
  status.textContent = 'Uploading...';
  status.style.color = 'var(--text3)';
  const formData = new FormData();
  formData.append('file', file);
  try {
    const res = await fetch('/api/backup/import', {
      method: 'POST',
      headers: { Authorization: `Bearer ${authToken}` },
      body: formData
    });
    if (!res.ok) throw new Error(await res.text());
    const r = await res.json();
    const added = Object.entries(r.records_added).map(([k,v]) => `${k}: +${v}`).join(', ');
    status.innerHTML = `<span style="color:var(--green)">âœ“ Import complete â€” ${added}</span>`;
    toast('Backup imported', 'success');
    loadDevices(); loadAssets();
  } catch(e) {
    status.innerHTML = `<span style="color:var(--red)">âœ— ${e.message}</span>`;
    toast('Import failed', 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HARDWARE INFO (device panel additions)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHardwareInfo(hw) {
  if (!hw || !Object.keys(hw).length) return '<div style="color:var(--text3);font-size:12px">No hardware data yet. Click "Scan Hardware" to collect.</div>';
  const sections = [];
  if (hw.cpu) sections.push(`<div class="card-label" style="margin-bottom:6px">CPU</div><div style="font-size:13px">${hw.cpu.name||'Unknown'}</div><div style="font-size:11px;color:var(--text3);font-family:var(--mono)">${hw.cpu.cores||'?'} cores â€¢ ${hw.cpu.threads||'?'} threads â€¢ ${hw.cpu.speed||'?'} GHz</div>`);
  if (hw.ram) sections.push(`<div class="card-label" style="margin:10px 0 6px">RAM</div><div style="font-size:13px">${hw.ram.total_gb||'?'} GB total</div><div style="font-size:11px;color:var(--text3);font-family:var(--mono)">${(hw.ram.slots||[]).map(s=>`${s.size}GB ${s.type||''} @${s.speed||'?'}MHz`).join(' â€¢ ')}</div>`);
  if (hw.gpu) sections.push(`<div class="card-label" style="margin:10px 0 6px">GPU</div><div style="font-size:13px">${hw.gpu.name||'Unknown'}</div>`);
  if (hw.disks) sections.push(`<div class="card-label" style="margin:10px 0 6px">Storage</div>${hw.disks.map(d=>`<div style="font-size:12px;font-family:var(--mono)">${d.model||d.name} â€¢ ${d.size||'?'} ${d.serial?'S/N:'+d.serial:''}</div>`).join('')}`);
  if (hw.motherboard) sections.push(`<div class="card-label" style="margin:10px 0 6px">Motherboard</div><div style="font-size:12px;font-family:var(--mono)">${hw.motherboard.manufacturer||''} ${hw.motherboard.model||''}</div>`);
  return sections.join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERRIDE showPage to load new pages
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origShowPage = showPage;
showPage = function(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const page = document.getElementById('page-' + name);
  if (page) page.classList.add('active');
  event?.currentTarget?.classList.add('active');
  if (name === 'tasks')     loadTasks();
  if (name === 'scripts')   loadScripts();
  if (name === 'inventory') loadAssets();
  if (name === 'settings')  loadSettings();
  if (name === 'logs')      loadLogs();
  if (name === 'lockdown')  loadLockdown();
  if (name === 'wol')       loadWol();
  if (name === 'email')     loadEmailSettings();
  if (name === 'asset-tags') refreshTagPreview();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATCH initApp to load lockdown status on boot
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origInit = initApp;
initApp = function() {
  _origInit();
  // Check lockdown status and show banner if active
  api('/api/lockdown/status').then(s => {
    const banner = document.getElementById('lockdownBanner');
    if (banner && s.active) banner.style.display = 'block';
  }).catch(()=>{});
  // Patch login to detect lockdown response
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATCH doLogin to handle lockdown 423 response
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origLogin = doLogin;
doLogin = async function() {
  const u = document.getElementById('loginUser').value;
  const p = document.getElementById('loginPass').value;
  try {
    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({username:u, password:p})
    });
    if (res.status === 423) {
      document.getElementById('loginError').innerHTML = 'ğŸ”’ LOCKDOWN MODE ACTIVE â€” Login is disabled by administrator';
      document.getElementById('loginError').style.color = '#ff5252';
      return;
    }
    const data = await res.json();
    if (data.token) {
      authToken = data.token;
      document.getElementById('loginScreen').style.display = 'none';
      initApp();
    } else {
      document.getElementById('loginError').textContent = data.detail || 'Invalid credentials';
    }
  } catch(e) {
    document.getElementById('loginError').textContent = 'Connection error';
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WoL MANUAL MODAL (add to existing modal handling)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  // Add WoL modal to DOM dynamically
  const wolModal = document.createElement('div');
  wolModal.className = 'modal-overlay';
  wolModal.id = 'modalWolManual';
  wolModal.innerHTML = `
    <div class="modal" style="width:400px">
      <div class="modal-header">
        <div class="modal-title">âš¡ Wake by MAC Address</div>
        <button class="modal-close" onclick="closeModal('modalWolManual')">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">MAC Address</label>
          <input class="form-input" id="wolMacInput" placeholder="AA:BB:CC:DD:EE:FF" style="font-family:var(--mono)">
        </div>
        <div class="form-group">
          <label class="form-label">Broadcast Address (optional)</label>
          <input class="form-input" id="wolBroadcast" value="255.255.255.255" style="font-family:var(--mono)">
        </div>
        <div style="font-size:12px;color:var(--text3)">Use this to wake devices not yet enrolled in the RMM, or your NAS/desktop by MAC directly.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('modalWolManual')">Cancel</button>
        <button class="btn btn-primary" onclick="wakeByMac()">âš¡ Send Wake Packet</button>
      </div>
    </div>`;
  document.body.appendChild(wolModal);
  wolModal.addEventListener('click', e => { if(e.target===wolModal) wolModal.classList.remove('open'); });
});

async function wakeByMac() {
  const mac = document.getElementById('wolMacInput')?.value;
  const broadcast = document.getElementById('wolBroadcast')?.value || '255.255.255.255';
  if (!mac) { toast('Enter a MAC address', 'error'); return; }
  try {
    await api('/api/wol/wake/mac', 'POST', {mac, broadcast});
    toast(`Magic packet sent to ${mac}`, 'success');
    closeModal('modalWolManual');
    loadWol();
  } catch(e) { toast('WoL failed: ' + e.message, 'error'); }
}

</script>
</body>
</html>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DARK / LIGHT MODE TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let darkMode = true;

function initTheme() {
  const saved = localStorage.getItem('rmm_dark') ?? 'true';
  darkMode = saved === 'true';
  applyTheme();
}

function applyTheme() {
  const r = document.documentElement.style;
  if (darkMode) {
    r.setProperty('--bg',    '#0a0a0a');
    r.setProperty('--bg2',   '#111');
    r.setProperty('--bg3',   '#1a1a1a');
    r.setProperty('--border','#222');
    r.setProperty('--text',  '#e0e0e0');
    r.setProperty('--text2', '#aaa');
    r.setProperty('--text3', '#666');
  } else {
    r.setProperty('--bg',    '#f5f5f5');
    r.setProperty('--bg2',   '#fff');
    r.setProperty('--bg3',   '#ececec');
    r.setProperty('--border','#ddd');
    r.setProperty('--text',  '#111');
    r.setProperty('--text2', '#444');
    r.setProperty('--text3', '#888');
  }
  const btn = document.getElementById('themeToggleBtn');
  if (btn) btn.textContent = darkMode ? 'â˜€ Light' : 'ğŸŒ™ Dark';
}

function toggleTheme() {
  darkMode = !darkMode;
  localStorage.setItem('rmm_dark', darkMode);
  applyTheme();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BULK ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedDevices = new Set();

function toggleDeviceSelect(deviceId) {
  if (selectedDevices.has(deviceId)) selectedDevices.delete(deviceId);
  else selectedDevices.add(deviceId);
  updateBulkBar();
}

function toggleSelectAll() {
  const checkboxes = document.querySelectorAll('.device-checkbox');
  const allChecked = [...checkboxes].every(c => c.checked);
  checkboxes.forEach(c => {
    c.checked = !allChecked;
    if (!allChecked) selectedDevices.add(c.dataset.id);
    else selectedDevices.delete(c.dataset.id);
  });
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById('bulkActionBar');
  const count = document.getElementById('bulkCount');
  const checkboxes = document.querySelectorAll('.device-checkbox');
  checkboxes.forEach(c => { c.checked = selectedDevices.has(c.dataset.id); });
  if (!bar) return;
  if (selectedDevices.size > 0) {
    bar.style.display = 'flex';
    count.textContent = selectedDevices.size + ' device' + (selectedDevices.size>1?'s':'') + ' selected';
  } else {
    bar.style.display = 'none';
  }
}

async function bulkRunTask() {
  if (selectedDevices.size === 0) return;
  const scriptBody = prompt('Enter PowerShell/Bash command to run on ' + selectedDevices.size + ' device(s):');
  if (!scriptBody) return;
  for (const deviceId of selectedDevices) {
    await api('/api/tasks/', 'POST', {
      name: 'Bulk Run ' + new Date().toLocaleTimeString(),
      script_type: 'powershell',
      script_body: scriptBody,
      target_type: 'device',
      target_id: deviceId,
      trigger_type: 'now'
    });
  }
  showToast(`Task sent to ${selectedDevices.size} devices`);
  selectedDevices.clear();
  updateBulkBar();
}

async function bulkWake() {
  for (const deviceId of selectedDevices) {
    await api(`/api/wol/wake/${deviceId}`, 'POST', {}).catch(()=>{});
  }
  showToast(`WoL sent to ${selectedDevices.size} devices`);
}

async function bulkAssignGroup() {
  const groups = await api('/api/groups/');
  if (!groups.length) { alert('No groups created yet. Create a group first.'); return; }
  const names = groups.map((g,i)=>`${i+1}. ${g.name}`).join('\n');
  const idx = parseInt(prompt('Choose group:\n' + names)) - 1;
  if (isNaN(idx) || idx < 0 || idx >= groups.length) return;
  const group = groups[idx];
  await api(`/api/groups/${group.id}/assign`, 'POST', { device_ids: [...selectedDevices] });
  showToast(`${selectedDevices.size} devices assigned to "${group.name}"`);
  selectedDevices.clear();
  updateBulkBar();
  loadDevices();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUICK ACTIONS (shutdown/restart/lock/sleep)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function quickAction(deviceId, action) {
  const labels = { shutdown:'Shut down', restart:'Restart', lock:'Lock screen', sleep:'Sleep' };
  if (!confirm(`${labels[action]} "${deviceId}"? This cannot be undone.`)) return;
  try {
    await api(`/api/processes/${deviceId}/action`, 'POST', { action });
    showToast(`${labels[action]} command sent`);
  } catch(e) {
    showToast('Device must be connected via WebSocket for quick actions', 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERFORMANCE HISTORY (Chart.js via CDN)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let perfChart = null;

function loadPerfHistory(deviceId) {
  if (!deviceId) return;
  const container = document.getElementById('perfChartContainer');
  if (!container) return;
  container.innerHTML = '<canvas id="perfChart" height="120"></canvas>';

  api(`/api/metrics/${deviceId}?hours=24`).then(data => {
    if (!data.length) {
      container.innerHTML = '<div style="color:var(--text3);text-align:center;padding:20px;font-size:12px">No history yet â€” check back after the device has been online for a while</div>';
      return;
    }
    const labels = data.map(d => new Date(d.t).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
    const cpu  = data.map(d => d.cpu);
    const ram  = data.map(d => d.ram);
    const disk = data.map(d => d.disk);

    if (perfChart) perfChart.destroy();
    const ctx = document.getElementById('perfChart').getContext('2d');
    perfChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'CPU %',  data: cpu,  borderColor: '#00e5ff', backgroundColor: 'rgba(0,229,255,.08)', tension:.3, pointRadius:0, fill:true },
          { label: 'RAM %',  data: ram,  borderColor: '#ff9800', backgroundColor: 'rgba(255,152,0,.08)',  tension:.3, pointRadius:0, fill:true },
          { label: 'Disk %', data: disk, borderColor: '#69ff47', backgroundColor: 'rgba(105,255,71,.08)', tension:.3, pointRadius:0, fill:true },
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#aaa', font:{size:11} } } },
        scales: {
          x: { ticks: { color:'#666', maxTicksLimit:8 }, grid: { color:'#1a1a1a' } },
          y: { min:0, max:100, ticks: { color:'#666' }, grid: { color:'#1a1a1a' } }
        }
      }
    });
  }).catch(e => console.warn('metrics error', e));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEVICE NOTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentNoteDeviceId = null;

async function loadNotes(deviceId) {
  currentNoteDeviceId = deviceId;
  const container = document.getElementById('notesContainer');
  if (!container) return;
  container.innerHTML = '<div style="color:var(--text3);font-size:12px">Loading...</div>';
  try {
    const notes = await api(`/api/notes/${deviceId}`);
    if (!notes.length) {
      container.innerHTML = '<div style="color:var(--text3);font-size:12px;padding:8px 0">No notes yet.</div>';
    } else {
      container.innerHTML = notes.map(n => `
        <div class="card" style="margin-bottom:8px;padding:10px 12px">
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div style="font-size:13px;line-height:1.5;white-space:pre-wrap">${escHtml(n.body)}</div>
            <button onclick="deleteNote('${n.id}')" style="background:none;border:none;color:var(--text3);cursor:pointer;margin-left:8px;font-size:14px">âœ•</button>
          </div>
          <div style="font-size:11px;color:var(--text3);margin-top:4px">${n.author} Â· ${new Date(n.created_at).toLocaleString()}</div>
        </div>`).join('');
    }
  } catch(e) { container.innerHTML = '<div style="color:#ff5252;font-size:12px">Failed to load notes</div>'; }
}

async function addNote() {
  const inp = document.getElementById('newNoteInput');
  if (!inp || !inp.value.trim() || !currentNoteDeviceId) return;
  await api(`/api/notes/${currentNoteDeviceId}`, 'POST', { body: inp.value.trim() });
  inp.value = '';
  loadNotes(currentNoteDeviceId);
}

async function deleteNote(noteId) {
  if (!confirm('Delete this note?')) return;
  await api(`/api/notes/${noteId}`, 'DELETE');
  loadNotes(currentNoteDeviceId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROCESS MANAGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let processDeviceId = null;
let allProcesses = [];

function openProcessManager(deviceId, hostname) {
  processDeviceId = deviceId;
  document.getElementById('processDeviceName').textContent = hostname;
  document.getElementById('processTable').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text3)">Click Refresh to load processes</td></tr>';
  openModal('modalProcessManager');
}

async function refreshProcesses() {
  if (!processDeviceId) return;
  document.getElementById('processTable').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:16px;color:var(--text3)">Requesting process list...</td></tr>';
  // The processes arrive via WebSocket; request them
  await api(`/api/processes/${processDeviceId}`, 'GET').catch(e => {
    document.getElementById('processTable').innerHTML = `<tr><td colspan="5" style="text-align:center;padding:16px;color:#ff5252">${e.message || 'Device offline'}</td></tr>`;
  });
}

function renderProcesses(procs) {
  allProcesses = procs;
  filterProcesses();
}

function filterProcesses() {
  const q = (document.getElementById('processSearch')?.value || '').toLowerCase();
  const filtered = allProcesses.filter(p => p.name.toLowerCase().includes(q));
  const tbody = document.getElementById('processTable');
  if (!tbody) return;
  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:16px;color:var(--text3)">No processes found</td></tr>';
    return;
  }
  tbody.innerHTML = filtered.map(p => `
    <tr>
      <td style="font-family:var(--mono);color:var(--text3)">${p.pid}</td>
      <td style="font-weight:600">${escHtml(p.name)}</td>
      <td>${p.cpu > 0 ? `<span style="color:${p.cpu>50?'#ff5252':p.cpu>20?'#ff9800':'var(--text)'}">${p.cpu}%</span>` : 'â€”'}</td>
      <td>${p.mem_mb > 0 ? p.mem_mb + ' MB' : 'â€”'}</td>
      <td><button class="btn btn-ghost btn-sm" onclick="killProcess(${p.pid},'${escHtml(p.name)}')" style="color:#ff5252;border-color:#ff5252">Kill</button></td>
    </tr>`).join('');
}

async function killProcess(pid, name) {
  if (!confirm(`Kill process "${name}" (PID ${pid})?`)) return;
  try {
    await api(`/api/processes/${processDeviceId}/kill`, 'POST', { pid, name });
    showToast(`Kill signal sent to ${name}`);
    setTimeout(refreshProcesses, 2000);
  } catch(e) { showToast('Failed: ' + e.message, 'error'); }
}

// Handle process list arriving via WebSocket
const _origWsMsg = typeof handleWsMessage === 'function' ? handleWsMessage : null;
function handleWsProcesses(msg) {
  if (msg.type === 'process_list' && msg.device_id === processDeviceId) {
    renderProcesses(msg.data || []);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEVICE GROUPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadGroups() {
  const groups = await api('/api/groups/');
  const grid = document.getElementById('groupsGrid');
  if (!grid) return;
  if (!groups.length) {
    grid.innerHTML = '<div style="color:var(--text3);text-align:center;padding:40px;grid-column:1/-1">No groups yet. Create one to start organizing devices.</div>';
    return;
  }
  grid.innerHTML = groups.map(g => `
    <div class="card" style="border-left:3px solid ${g.color}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <div>
          <div style="font-weight:700;font-size:15px">${escHtml(g.name)}</div>
          <div style="font-size:12px;color:var(--text3)">${g.description || 'No description'}</div>
        </div>
        <button onclick="deleteGroup('${g.id}','${escHtml(g.name)}')" style="background:none;border:none;color:var(--text3);cursor:pointer">âœ•</button>
      </div>
      <div style="font-size:24px;font-weight:700;color:${g.color}">${g.device_count}</div>
      <div style="font-size:11px;color:var(--text3)">DEVICES</div>
    </div>`).join('');
}

async function createGroup() {
  const name = document.getElementById('newGroupName').value.trim();
  if (!name) return;
  await api('/api/groups/', 'POST', {
    name,
    description: document.getElementById('newGroupDesc').value,
    color: document.getElementById('newGroupColor').value
  });
  closeModal('modalCreateGroup');
  document.getElementById('newGroupName').value = '';
  loadGroups();
  showToast('Group created');
}

async function deleteGroup(id, name) {
  if (!confirm(`Delete group "${name}"? Devices will be unassigned.`)) return;
  await api(`/api/groups/${id}`, 'DELETE');
  loadGroups();
  showToast('Group deleted');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOFTWARE INVENTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allSoftwareRows = [];

async function loadSoftware() {
  const deviceId = document.getElementById('softwareDeviceFilter')?.value || '';
  const tbody = document.getElementById('softwareTable');
  if (!tbody) return;

  // Populate device dropdown
  const sel = document.getElementById('softwareDeviceFilter');
  if (sel && sel.options.length <= 1) {
    const devices = await api('/api/devices/');
    devices.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.device_id;
      opt.textContent = d.label || d.hostname;
      sel.appendChild(opt);
    });
  }

  if (!deviceId) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text3)">Select a device above</td></tr>'; return; }

  tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text3)">Loading...</td></tr>';
  const apps = await api(`/api/software/${deviceId}`);
  allSoftwareRows = apps.map(a => ({...a, deviceId}));
  filterSoftwareTable();
}

function filterSoftwareTable() {
  const q = (document.getElementById('softwareSearch')?.value || '').toLowerCase();
  const filtered = allSoftwareRows.filter(a =>
    a.name.toLowerCase().includes(q) || (a.publisher||'').toLowerCase().includes(q)
  );
  const tbody = document.getElementById('softwareTable');
  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text3)">No matching applications</td></tr>';
    return;
  }
  tbody.innerHTML = filtered.map(a => `
    <tr>
      <td style="font-weight:600">${escHtml(a.name)}</td>
      <td style="font-family:var(--mono);font-size:12px">${escHtml(a.version||'â€”')}</td>
      <td>${escHtml(a.publisher||'â€”')}</td>
      <td style="color:var(--text3)">${a.install_date||'â€”'}</td>
      <td style="color:var(--text3)">${a.deviceId}</td>
      <td><button class="btn btn-ghost btn-sm" onclick="requestSoftwareScan('${a.deviceId}')">â†» Rescan</button></td>
    </tr>`).join('');
}

async function requestSoftwareScan(deviceId) {
  await api(`/api/software/${deviceId}/scan`, 'POST', {});
  showToast('Software scan requested â€” results in ~30s');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERT RULES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAlertRules() {
  const rules = await api('/api/alert-rules/');
  const container = document.getElementById('alertRulesContainer');
  if (!container) return;
  if (!rules.length) {
    container.innerHTML = '<div style="color:var(--text3);text-align:center;padding:40px">No alert rules. Create one to start monitoring thresholds.</div>';
    return;
  }
  const opLabel = {gt:'>', lt:'<', eq:'='};
  container.innerHTML = `<div class="table-wrap"><table>
    <thead><tr><th>Name</th><th>Metric</th><th>Condition</th><th>Target</th><th>Action</th><th>Last Fired</th><th>Active</th><th></th></tr></thead>
    <tbody>` + rules.map(r => `
    <tr>
      <td style="font-weight:600">${escHtml(r.name)}</td>
      <td style="font-family:var(--mono)">${r.metric.toUpperCase()}</td>
      <td style="font-family:var(--mono)">${opLabel[r.operator]||r.operator} ${r.threshold}% for ${r.duration_minutes}min</td>
      <td style="color:var(--text3)">${r.target_type === 'device' ? r.target_id : 'All Devices'}</td>
      <td>${r.action}</td>
      <td style="color:var(--text3);font-size:12px">${r.last_fired ? new Date(r.last_fired).toLocaleString() : 'â€”'}</td>
      <td><span style="color:${r.active?'#69ff47':'#666'}">${r.active?'â—':'â—‹'}</span></td>
      <td>
        <button class="btn btn-ghost btn-sm" onclick="toggleAlertRule('${r.id}',${!r.active})">${r.active?'Disable':'Enable'}</button>
        <button class="btn btn-ghost btn-sm" onclick="deleteAlertRule('${r.id}')" style="color:#ff5252">Del</button>
      </td>
    </tr>`).join('') + `</tbody></table></div>`;
}

async function createAlertRule() {
  const target = document.getElementById('ruleTargetInput').value;
  await api('/api/alert-rules/', 'POST', {
    name: document.getElementById('ruleNameInput').value,
    metric: document.getElementById('ruleMetricInput').value,
    operator: document.getElementById('ruleOperatorInput').value,
    threshold: parseFloat(document.getElementById('ruleThresholdInput').value),
    duration_minutes: parseInt(document.getElementById('ruleDurationInput').value),
    target_type: target,
    target_id: target === 'device' ? document.getElementById('ruleDeviceInput').value : null,
    action: 'email'
  });
  closeModal('modalCreateAlertRule');
  loadAlertRules();
  showToast('Alert rule created');
}

async function toggleAlertRule(id, active) {
  await api(`/api/alert-rules/${id}`, 'PUT', { active });
  loadAlertRules();
}

async function deleteAlertRule(id) {
  if (!confirm('Delete this alert rule?')) return;
  await api(`/api/alert-rules/${id}`, 'DELETE');
  loadAlertRules();
  showToast('Rule deleted');
}

function toggleRuleDeviceSelect(val) {
  document.getElementById('ruleDeviceSelectGroup').style.display = val === 'device' ? '' : 'none';
}

async function populateRuleDeviceSelect() {
  const sel = document.getElementById('ruleDeviceInput');
  if (sel.options.length > 0) return;
  const devices = await api('/api/devices/');
  devices.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d.device_id;
    opt.textContent = d.label || d.hostname;
    sel.appendChild(opt);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function previewReport() {
  const frame = document.getElementById('reportPreviewFrame');
  if (frame) frame.src = '/api/reports/preview';
}

async function sendReportNow() {
  try {
    await api('/api/reports/send', 'POST', {});
    showToast('Report sent!');
  } catch(e) { showToast('Failed: ' + e.message, 'error'); }
}

async function saveReportSettings() {
  const val = document.getElementById('reportSchedule').value;
  await api('/api/settings/', 'PUT', { key: 'report_schedule', value: val });
  showToast('Saved');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST NOTIFICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, type='success') {
  const existing = document.getElementById('rmmToast');
  if (existing) existing.remove();
  const t = document.createElement('div');
  t.id = 'rmmToast';
  t.textContent = msg;
  t.style.cssText = `position:fixed;bottom:24px;right:24px;z-index:9999;padding:12px 20px;border-radius:6px;font-size:13px;font-family:var(--mono);background:${type==='error'?'#ff5252':'#69ff47'};color:#000;box-shadow:0 4px 20px rgba(0,0,0,.4);animation:fadeIn .2s`;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATCH showPage to load new pages
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _showPageOrig = showPage;
showPage = function(name) {
  _showPageOrig(name);
  if (name === 'groups')      loadGroups();
  if (name === 'software')    loadSoftware();
  if (name === 'alert-rules') { loadAlertRules(); populateRuleDeviceSelect(); }
  if (name === 'reports')     previewReport();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATCH WebSocket to handle new message types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origConnectWs = connectWebSocket;
connectWebSocket = function() {
  _origConnectWs();
  // Monkey-patch the ws.onmessage after a tick
  setTimeout(() => {
    if (!window._wsPatched && window.ws) {
      const origOnMsg = ws.onmessage;
      ws.onmessage = function(e) {
        try {
          const msg = JSON.parse(e.data);
          handleWsProcesses(msg);
        } catch {}
        if (origOnMsg) origOnMsg.call(this, e);
      };
      window._wsPatched = true;
    }
  }, 500);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATCH device panel to show new tabs: Notes, Perf History, Software, Processes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origShowDevicePanel = typeof showDevicePanel === 'function' ? showDevicePanel : null;

function injectDevicePanelExtras(deviceId, hostname) {
  // Add extra tabs to device panel if not already there
  const tabBar = document.querySelector('.device-panel-tabs');
  if (!tabBar || tabBar.dataset.extended) return;
  tabBar.dataset.extended = '1';

  const extraTabs = [
    { id: 'tab-perf',      label: 'ğŸ“ˆ Performance' },
    { id: 'tab-notes',     label: 'ğŸ“ Notes' },
    { id: 'tab-software',  label: 'ğŸ“‹ Software' },
    { id: 'tab-processes', label: 'âš™ Processes' },
  ];
  extraTabs.forEach(t => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn';
    btn.id = t.id;
    btn.textContent = t.label;
    btn.onclick = () => switchDeviceTab(t.id.replace('tab-',''), deviceId, hostname);
    tabBar.appendChild(btn);
  });

  // Add content areas
  const body = document.querySelector('.device-panel-body') || document.querySelector('#devicePanel .panel-body');
  if (body) {
    body.insertAdjacentHTML('beforeend', `
      <div id="pane-perf" class="device-pane" style="display:none">
        <div style="margin-bottom:8px;font-size:12px;color:var(--text3)">Last 24 hours â€” updates each heartbeat</div>
        <div id="perfChartContainer" style="height:140px"></div>
      </div>
      <div id="pane-notes" class="device-pane" style="display:none">
        <div id="notesContainer" style="margin-bottom:12px"></div>
        <div style="display:flex;gap:8px">
          <input class="form-input" id="newNoteInput" placeholder="Add a note..." style="flex:1" onkeydown="if(event.key==='Enter')addNote()">
          <button class="btn btn-primary btn-sm" onclick="addNote()">Add</button>
        </div>
      </div>
      <div id="pane-software" class="device-pane" style="display:none">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input class="form-input" id="panelSoftwareSearch" placeholder="Filter..." oninput="filterPanelSoftware()" style="flex:1">
          <button class="btn btn-ghost btn-sm" onclick="requestSoftwareScan('${deviceId}')">â†» Scan</button>
        </div>
        <div id="panelSoftwareList" style="max-height:320px;overflow-y:auto;font-size:12px"></div>
      </div>
      <div id="pane-processes" class="device-pane" style="display:none">
        <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
          <input class="form-input" id="panelProcessSearch" placeholder="Filter processes..." oninput="filterPanelProcesses()" style="flex:1">
          <button class="btn btn-ghost btn-sm" onclick="openProcessManager('${deviceId}','${hostname}')">Open Full View</button>
        </div>
        <div style="font-size:12px;color:var(--text3)">Use the process manager button for kill functionality.</div>
      </div>
    `);
  }
  loadPerfHistory(deviceId);
  loadNotes(deviceId);
}

function switchDeviceTab(tab, deviceId, hostname) {
  document.querySelectorAll('.device-pane').forEach(p => p.style.display = 'none');
  const pane = document.getElementById('pane-' + tab);
  if (pane) pane.style.display = '';
  if (tab === 'perf')      loadPerfHistory(deviceId);
  if (tab === 'notes')     loadNotes(deviceId);
  if (tab === 'software')  loadPanelSoftware(deviceId);
}

async function loadPanelSoftware(deviceId) {
  const container = document.getElementById('panelSoftwareList');
  if (!container) return;
  container.innerHTML = '<div style="color:var(--text3)">Loading...</div>';
  const apps = await api(`/api/software/${deviceId}`).catch(() => []);
  if (!apps.length) { container.innerHTML = '<div style="color:var(--text3)">No software data. Click Scan.</div>'; return; }
  container.dataset.apps = JSON.stringify(apps);
  filterPanelSoftware();
}

function filterPanelSoftware() {
  const q = (document.getElementById('panelSoftwareSearch')?.value||'').toLowerCase();
  const container = document.getElementById('panelSoftwareList');
  if (!container || !container.dataset.apps) return;
  const apps = JSON.parse(container.dataset.apps).filter(a => a.name.toLowerCase().includes(q));
  container.innerHTML = apps.map(a =>
    `<div style="padding:5px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between">
      <span>${escHtml(a.name)}</span>
      <span style="color:var(--text3)">${escHtml(a.version||'â€”')}</span>
    </div>`
  ).join('');
}

function filterPanelProcesses() {}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATCH DEVICES PAGE to add checkboxes + quick actions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origLoadDevices = loadDevices;
loadDevices = async function() {
  await _origLoadDevices();
  // Inject bulk action bar above table if not present
  const devicePage = document.getElementById('page-devices');
  if (!devicePage) return;
  if (!document.getElementById('bulkActionBar')) {
    const bar = document.createElement('div');
    bar.id = 'bulkActionBar';
    bar.style.cssText = 'display:none;align-items:center;gap:12px;padding:10px 16px;background:var(--bg2);border:1px solid var(--accent);border-radius:6px;margin-bottom:12px;font-size:13px;position:sticky;top:60px;z-index:100';
    bar.innerHTML = `
      <span id="bulkCount" style="font-weight:600;color:var(--accent)"></span>
      <button class="btn btn-primary btn-sm" onclick="bulkRunTask()">â–¶ Run Script</button>
      <button class="btn btn-ghost btn-sm" onclick="bulkWake()">âš¡ Wake All</button>
      <button class="btn btn-ghost btn-sm" onclick="bulkAssignGroup()">ğŸ—‚ Assign Group</button>
      <button class="btn btn-ghost btn-sm" onclick="selectedDevices.clear();updateBulkBar()">âœ• Clear</button>`;
    const tableWrap = devicePage.querySelector('.table-wrap');
    if (tableWrap) tableWrap.parentNode.insertBefore(bar, tableWrap);
  }
  // Add checkboxes to each device row
  const rows = devicePage.querySelectorAll('tbody tr[data-device-id]');
  rows.forEach(row => {
    const did = row.dataset.deviceId;
    if (!did || row.querySelector('.device-checkbox')) return;
    const td = document.createElement('td');
    td.innerHTML = `<input type="checkbox" class="device-checkbox" data-id="${did}" onclick="toggleDeviceSelect('${did}')">`;
    row.prepend(td);
    // Quick action buttons
    const last = row.querySelector('td:last-child');
    if (last) {
      last.innerHTML += `
        <button title="Restart" class="btn btn-ghost btn-sm" onclick="quickAction('${did}','restart')" style="padding:2px 6px">â†º</button>
        <button title="Lock" class="btn btn-ghost btn-sm" onclick="quickAction('${did}','lock')" style="padding:2px 6px">ğŸ”’</button>
        <button title="Shutdown" class="btn btn-ghost btn-sm" onclick="quickAction('${did}','shutdown')" style="color:#ff5252;padding:2px 6px">â»</button>
        <button title="Processes" class="btn btn-ghost btn-sm" onclick="openProcessManager('${did}','${did}')" style="padding:2px 6px">âš™</button>`;
    }
  });
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Load Chart.js dynamically
(function() {
  const s = document.createElement('script');
  s.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js';
  s.crossOrigin = 'anonymous';
  document.head.appendChild(s);
})();

// Apply theme on load
document.addEventListener('DOMContentLoaded', () => { initTheme(); });

// Add theme toggle button to nav footer
document.addEventListener('DOMContentLoaded', () => {
  const nav = document.querySelector('.nav') || document.querySelector('nav');
  if (nav) {
    const btn = document.createElement('button');
    btn.id = 'themeToggleBtn';
    btn.className = 'btn btn-ghost';
    btn.style.cssText = 'width:calc(100% - 32px);margin:8px 16px 16px;font-size:12px';
    btn.textContent = 'â˜€ Light';
    btn.onclick = toggleTheme;
    nav.appendChild(btn);
  }
});
</script>
